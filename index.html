<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>í•™êµ í‰ê°€ ë¶„ì„ ëŒ€ì‹œë³´ë“œ - Premium Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&family=Noto+Sans+KR:wght@300;400;500;600;700;800;900&display=swap">
    
    <style>
      :root {
        --primary: #6366F1;
        --primary-dark: #4F46E5;
        --secondary: #EC4899;
        --accent: #F59E0B;
        --success: #10B981;
        --warning: #F59E0B;
        --danger: #EF4444;
        --dark: #0F172A;
        --light: #F8FAFC;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Poppins', 'Noto Sans KR', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #1e293b;
        overflow-x: hidden;
      }

      /* Glassmorphism */
      .glass {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }

      .glass-white {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
      }

      /* Premium Card */
      .premium-card {
        background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.85) 100%);
        backdrop-filter: blur(20px);
        border-radius: 24px;
        border: 1px solid rgba(255, 255, 255, 0.5);
        box-shadow: 
          0 20px 60px rgba(0, 0, 0, 0.1),
          0 0 0 1px rgba(255, 255, 255, 0.5) inset;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
        position: relative;
      }

      .premium-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
        opacity: 0;
        transition: opacity 0.3s;
      }

      .premium-card:hover {
        transform: translateY(-8px);
        box-shadow: 
          0 30px 80px rgba(0, 0, 0, 0.15),
          0 0 0 1px rgba(255, 255, 255, 0.5) inset;
      }

      .premium-card:hover::before {
        opacity: 1;
      }

      /* Animated Gradient Text */
      .gradient-text {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        background-size: 200% 200%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        animation: gradientShift 4s ease infinite;
      }

      @keyframes gradientShift {
        0%, 100% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
      }

      /* Floating Animation */
      @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-20px); }
      }

      .float {
        animation: float 6s ease-in-out infinite;
      }

      /* Pulse Animation */
      @keyframes pulse-slow {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.8; transform: scale(1.05); }
      }

      .pulse-slow {
        animation: pulse-slow 3s ease-in-out infinite;
      }

      /* Glow Animation */
      @keyframes glow {
        0%, 100% { 
          box-shadow: 0 0 20px rgba(99, 102, 241, 0.5), 0 0 40px rgba(99, 102, 241, 0.3), 0 0 60px rgba(99, 102, 241, 0.1);
        }
        50% { 
          box-shadow: 0 0 40px rgba(99, 102, 241, 0.8), 0 0 80px rgba(99, 102, 241, 0.5), 0 0 120px rgba(99, 102, 241, 0.3);
        }
      }

      .glow {
        animation: glow 2s ease-in-out infinite;
      }

      /* Bounce Animation */
      @keyframes bounce {
        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
        40% { transform: translateY(-30px); }
        60% { transform: translateY(-15px); }
      }

      .bounce {
        animation: bounce 2s ease infinite;
      }

      /* Zoom In Animation */
      @keyframes zoomIn {
        from {
          opacity: 0;
          transform: scale(0.3);
        }
        50% {
          opacity: 1;
        }
        to {
          transform: scale(1);
        }
      }

      .zoom-in {
        animation: zoomIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
      }

      /* Flip Animation */
      @keyframes flipIn {
        from {
          transform: perspective(400px) rotateY(90deg);
          opacity: 0;
        }
        to {
          transform: perspective(400px) rotateY(0);
          opacity: 1;
        }
      }

      .flip-in {
        animation: flipIn 0.8s ease-out forwards;
      }

      /* Slide Up Bounce */
      @keyframes slideUpBounce {
        0% {
          opacity: 0;
          transform: translateY(100px);
        }
        60% {
          transform: translateY(-20px);
        }
        80% {
          transform: translateY(10px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .slide-up-bounce {
        animation: slideUpBounce 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
      }

      /* Rotate In */
      @keyframes rotateIn {
        from {
          transform: rotate(-200deg) scale(0);
          opacity: 0;
        }
        to {
          transform: rotate(0) scale(1);
          opacity: 1;
        }
      }

      .rotate-in {
        animation: rotateIn 0.8s ease-out forwards;
      }

      /* Sparkle Animation */
      @keyframes sparkle {
        0%, 100% { opacity: 1; transform: scale(1) rotate(0deg); }
        25% { opacity: 0.8; transform: scale(1.2) rotate(90deg); }
        50% { opacity: 1; transform: scale(0.8) rotate(180deg); }
        75% { opacity: 0.8; transform: scale(1.1) rotate(270deg); }
      }

      .sparkle {
        animation: sparkle 2s ease-in-out infinite;
      }

      /* Wave Animation */
      @keyframes wave {
        0%, 100% { transform: translateY(0); }
        25% { transform: translateY(-10px); }
        75% { transform: translateY(10px); }
      }

      .wave-1 { animation: wave 1.5s ease-in-out infinite; animation-delay: 0s; }
      .wave-2 { animation: wave 1.5s ease-in-out infinite; animation-delay: 0.1s; }
      .wave-3 { animation: wave 1.5s ease-in-out infinite; animation-delay: 0.2s; }
      .wave-4 { animation: wave 1.5s ease-in-out infinite; animation-delay: 0.3s; }

      /* Fade In Animations */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(60px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .fade-in-up {
        animation: fadeInUp 0.8s ease-out forwards;
      }

      @keyframes fadeInScale {
        from {
          opacity: 0;
          transform: scale(0.8);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      .fade-in-scale {
        animation: fadeInScale 0.8s ease-out forwards;
      }

      /* Slide Transitions */
      @keyframes slideInRight {
        from {
          opacity: 0;
          transform: translateX(100px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .slide-in-right {
        animation: slideInRight 0.8s ease-out forwards;
      }

      /* Number Counter Animation */
      .number-counter {
        font-variant-numeric: tabular-nums;
        font-feature-settings: 'tnum';
      }

      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }

      ::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
      }

      ::-webkit-scrollbar-thumb {
        background: rgba(99, 102, 241, 0.5);
        border-radius: 10px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: rgba(99, 102, 241, 0.7);
      }

      /* Button Styles */
      .btn-premium {
        position: relative;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .btn-premium::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
      }

      .btn-premium:hover::before {
        width: 300px;
        height: 300px;
      }

      /* Presentation Styles */
      .presentation-slide {
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        position: relative;
        overflow: hidden;
      }

      .presentation-slide::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(99, 102, 241, 0.1) 0%, transparent 70%);
        animation: rotate 20s linear infinite;
      }

      @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }

      /* Loading Animation */
      @keyframes shimmer {
        0% {
          background-position: -1000px 0;
        }
        100% {
          background-position: 1000px 0;
        }
      }

      .shimmer {
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        background-size: 1000px 100%;
        animation: shimmer 2s infinite;
      }

      /* Responsive Typography - Larger */
      .display-1 {
        font-size: clamp(4rem, 10vw, 8rem);
        font-weight: 900;
        line-height: 1.1;
        letter-spacing: -0.02em;
      }

      .display-2 {
        font-size: clamp(3rem, 7vw, 5rem);
        font-weight: 800;
        line-height: 1.2;
        letter-spacing: -0.01em;
      }

      .display-3 {
        font-size: clamp(2rem, 5vw, 4rem);
        font-weight: 700;
        line-height: 1.3;
      }

      /* Form Styles */
      .form-input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 14px;
        transition: all 0.3s;
        background: white;
      }

      .form-input:focus {
        outline: none;
        border-color: #6366F1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      }

      .form-label {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
        font-weight: 600;
        color: #475569;
      }

      /* Stagger Animation Delays */
      .stagger-1 { animation-delay: 0.1s; }
      .stagger-2 { animation-delay: 0.2s; }
      .stagger-3 { animation-delay: 0.3s; }
      .stagger-4 { animation-delay: 0.4s; }
      .stagger-5 { animation-delay: 0.5s; }
      .stagger-6 { animation-delay: 0.6s; }

      /* Progress Bar Animation */
      @keyframes progressFill {
        from { width: 0%; }
      }

      .progress-animate {
        animation: progressFill 2s ease-out forwards;
      }

      /* Card Hover 3D Effect */
      .card-3d {
        transition: transform 0.3s ease;
        transform-style: preserve-3d;
      }

      .card-3d:hover {
        transform: perspective(1000px) rotateX(5deg) rotateY(-5deg) translateZ(20px);
      }
      
      /* File Upload Styles */
      .file-upload-zone {
        border: 2px dashed #cbd5e1;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
      }
      
      .file-upload-zone:hover {
        border-color: #6366F1;
        background: rgba(99, 102, 241, 0.05);
      }
      
      .file-upload-zone.has-file {
        border-color: #10B981;
        background: rgba(16, 185, 129, 0.05);
      }
    </style>
</head>
<body>
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;
        const { createRoot } = ReactDOM;

        // Default Data Template
        const getDefaultData = () => ({
          "schoolName": "í•™êµëª…ì„ ì…ë ¥í•˜ì„¸ìš”",
          "academicYear": "2025",
          "semester": "2í•™ê¸°",
          "kpiData": [
                    {
                              "title": "ì¢…í•© ë§Œì¡±ë„",
                              "value": 0,
                              "total": 5.0,
                              "change": 0,
                              "changeType": "neutral",
                              "targetSlide": 1,
                              "icon": "â­"
                    },
                    {
                              "title": "ì´ ì°¸ì—¬ ì¸ì›",
                              "value": 0,
                              "unit": "ëª…",
                              "change": 0,
                              "changeType": "neutral",
                              "targetSlide": 2,
                              "icon": "ğŸ‘¥"
                    },
                    {
                              "title": "ì „ë…„ ëŒ€ë¹„ ë³€í™”",
                              "value": 0,
                              "unit": "ì ",
                              "change": 0,
                              "changeType": "neutral",
                              "targetSlide": 7,
                              "icon": "ğŸ“ˆ"
                    }
          ],
          "categoryData": [
                    { "name": "í•™êµìì¹˜", "2024": 0, "2025": 0 },
                    { "name": "êµìœ¡ê³¼ì • í¸ì„±Â·ìš´ì˜", "2024": 0, "2025": 0 },
                    { "name": "ìˆ˜ì—…Â·í‰ê°€ í˜ì‹ ", "2024": 0, "2025": 0 },
                    { "name": "ì±…ì„êµìœ¡", "2024": 0, "2025": 0 },
                    { "name": "ì¸ë¬¸Â·ê³¼í•™Â·ì˜ˆì²´ëŠ¥", "2024": 0, "2025": 0 },
                    { "name": "ë¯¼ì£¼ì‹œë¯¼ êµìœ¡", "2024": 0, "2025": 0 },
                    { "name": "ì•ˆì „í•œ êµìœ¡ê³µê°„", "2024": 0, "2025": 0 }
          ],
          "respondentData": [
                    { "name": "êµì›", "value": 0, "color": "#6366F1", "avg": 0 },
                    { "name": "í•™ìƒ", "value": 0, "color": "#EC4899", "avg": 0 },
                    { "name": "í•™ë¶€ëª¨", "value": 0, "color": "#10B981", "avg": 0 },
                    { "name": "ì§ì›", "value": 0, "color": "#F59E0B", "avg": 0 }
          ],
          "trendData": [
                    { "year": "2022", "teacher": 0, "student": 0, "parent": 0, "staff": 0, "overall": 0 },
                    { "year": "2023", "teacher": 0, "student": 0, "parent": 0, "staff": 0, "overall": 0 },
                    { "year": "2024", "teacher": 0, "student": 0, "parent": 0, "staff": 0, "overall": 0 },
                    { "year": "2025", "teacher": 0, "student": 0, "parent": 0, "staff": 0, "overall": 0 }
          ],
          "comparisonData": {
                    "teacher": { "average": 0, "highest": 0, "lowest": 0 },
                    "student": { "average": 0, "highest": 0, "lowest": 0 },
                    "parent": { "average": 0, "highest": 0, "lowest": 0 },
                    "staff": { "average": 0, "highest": 0, "lowest": 0 }
          },
          "topBottomItems": {
                    "teacherTop": [],
                    "teacherBottom": [],
                    "studentTop": [],
                    "studentBottom": []
          },
          "aiInsights": [],
          "voices": [],
          // Response Rates separated by group
          "responseRates": {
              "teacher": 100,
              "student": 100,
              "parent": 100,
              "staff": 100
          },
          "actionItems": [],
          "roadmap": [
                    { "quarter": "1ë¶„ê¸°", "period": "3-5ì›”", "task": "ê°œì„  ê³„íš ìˆ˜ë¦½", "color": "#6366F1" },
                    { "quarter": "2ë¶„ê¸°", "period": "6-8ì›”", "task": "ì‹¤í–‰ ë° ëª¨ë‹ˆí„°ë§", "color": "#10B981" },
                    { "quarter": "3ë¶„ê¸°", "period": "9-11ì›”", "task": "ì¤‘ê°„ ì ê²€ ë° ë³´ì™„", "color": "#F59E0B" },
                    { "quarter": "4ë¶„ê¸°", "period": "12-2ì›”", "task": "íš¨ê³¼ ì¸¡ì • ë° í”¼ë“œë°±", "color": "#EC4899" }
          ],
          "goal": { "currentScore": 0, "targetScore": 4.2, "currentRank": 0, "targetRank": 0, "totalSchools": 0 }
        });

        // LocalStorage Keys
        const STORAGE_KEY = 'schoolEvaluationData_v2';
        
        // Load data from localStorage
        const loadFromStorage = () => {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    // Migration checks
                    if (!parsed.responseRates) {
                        parsed.responseRates = { teacher: 100, student: 100, parent: 100, staff: 100 };
                    }
                    return parsed;
                }
            } catch (e) {
                console.error('Failed to load from localStorage:', e);
            }
            return null;
        };
        
        // Save data to localStorage
        const saveToStorage = (data) => {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                return true;
            } catch (e) {
                console.error('Failed to save to localStorage:', e);
                return false;
            }
        };

        // Excel Parser Functions
        const parseExcelFile = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                        resolve(jsonData);
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        };

        // Parse respondent file (êµì›/í•™ìƒ/í•™ë¶€ëª¨/ì§ì›)
        const parseRespondentFile = (data, type) => {
            const result = {
                respondentCount: 0,
                averageScore: 0,
                highestScore: 0,
                lowestScore: 5,
                highestItem: { title: '', score: 0 },
                lowestItem: { title: '', score: 5 },
                topItems: [],
                bottomItems: [],
                subCategoryScores: {},      // ì„¸ë¶€ì˜ì—­ë³„ í˜„ì¬ ì ìˆ˜
                subCategoryScoresPrev: {},  // ì„¸ë¶€ì˜ì—­ë³„ ì „ë…„ë„ ì ìˆ˜
                allItems: []
            };
            
            // ì´ ì‘ë‹µì¸ì› ì°¾ê¸° (í–‰ 0, ì—´ 10)
            if (data[0] && data[0][10] !== undefined && typeof data[0][10] === 'number') {
                result.respondentCount = data[0][10];
            }
            
            // ì‘ë‹µì¸ì›ì„ ëª» ì°¾ìœ¼ë©´ ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ ì‹œë„
            if (result.respondentCount === 0) {
                for (let i = 0; i < Math.min(3, data.length); i++) {
                    for (let j = 8; j < 12; j++) {
                        const cell = data[i] && data[i][j];
                        if (typeof cell === 'number' && cell >= 10 && cell <= 2000) {
                            result.respondentCount = cell;
                            break;
                        }
                    }
                    if (result.respondentCount > 0) break;
                }
            }

            let currentCategory = '';
            let currentSubCategory = '';
            let scores = [];
            let subCategoryItemScores = {};  // ì„¸ë¶€ì˜ì—­ë³„ ë¬¸í•­ ì ìˆ˜ë“¤
            
            // í–‰ 3ë¶€í„° ë°ì´í„° íŒŒì‹± (ì‘ë‹µì¸ì› í–‰ë§Œ ì²˜ë¦¬)
            for (let i = 3; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length < 11) continue;
                
                // ì—´ 4ê°€ 'ì‘ë‹µì¸ì›'ì¸ í–‰ë§Œ ì²˜ë¦¬
                const col4 = row[4];
                if (!col4 || String(col4).trim() !== 'ì‘ë‹µì¸ì›') continue;
                
                // ì˜ì—­ (ì—´ 0)
                const col0 = row[0];
                if (col0 && typeof col0 === 'string' && col0.length > 0) {
                    currentCategory = col0.replace(/[\n\r]/g, ' ').trim();
                }
                
                // ì„¸ë¶€ì˜ì—­ (ì—´ 1)
                const col1 = row[1];
                if (col1 && typeof col1 === 'string' && col1.length > 0) {
                    currentSubCategory = col1.replace(/[\n\r]/g, ' ').trim();
                }
                
                // ì§ˆë¬¸ í…ìŠ¤íŠ¸ (ì—´ 3)
                const questionText = row[3];
                if (!questionText || typeof questionText !== 'string') continue;
                
                // ì ìˆ˜ (ì—´ 10)
                const score = row[10];
                if (typeof score !== 'number' || score < 1 || score > 5) continue;
                
                // 2024ë…„ë„ ì ìˆ˜ (ì—´ 12)
                const prevScore = row[12];
                
                // ì„¸ë¶€ì˜ì—­ë³„ ì ìˆ˜ ìˆ˜ì§‘
                if (currentSubCategory) {
                    if (!subCategoryItemScores[currentSubCategory]) {
                        subCategoryItemScores[currentSubCategory] = { current: [], prev: [] };
                    }
                    subCategoryItemScores[currentSubCategory].current.push(score);
                    if (typeof prevScore === 'number' && prevScore >= 1 && prevScore <= 5) {
                        subCategoryItemScores[currentSubCategory].prev.push(prevScore);
                    }
                }
                
                // ì§ˆë¬¸ í…ìŠ¤íŠ¸ ì •ë¦¬
                const cleanQuestion = questionText.split('\n')[0].replace(/^\d+\.\s*/, '').trim();
                
                if (cleanQuestion.length > 5) {
                    const item = {
                        title: cleanQuestion.length > 60 ? cleanQuestion.substring(0, 60) + '...' : cleanQuestion,
                        score: parseFloat(score.toFixed(2)),
                        category: currentCategory,
                        subCategory: currentSubCategory
                    };
                    
                    result.allItems.push(item);
                    scores.push(score);
                    
                    if (score > result.highestScore) {
                        result.highestScore = score;
                        result.highestItem = item;
                    }
                    if (score < result.lowestScore) {
                        result.lowestScore = score;
                        result.lowestItem = item;
                    }
                }
            }
            
            // ì„¸ë¶€ì˜ì—­ë³„ í‰ê·  ì ìˆ˜ ê³„ì‚°
            for (const [subCat, itemScores] of Object.entries(subCategoryItemScores)) {
                if (itemScores.current.length > 0) {
                    result.subCategoryScores[subCat] = parseFloat(
                        (itemScores.current.reduce((a, b) => a + b, 0) / itemScores.current.length).toFixed(2)
                    );
                }
                if (itemScores.prev.length > 0) {
                    result.subCategoryScoresPrev[subCat] = parseFloat(
                        (itemScores.prev.reduce((a, b) => a + b, 0) / itemScores.prev.length).toFixed(2)
                    );
                }
            }
            
            // ì „ì²´ í‰ê·  ì ìˆ˜ ê³„ì‚°
            if (scores.length > 0) {
                result.averageScore = parseFloat((scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(2));
            }
            
            // TOP 3 / í•˜ìœ„ 3 ì •ë ¬
            const sortedItems = [...result.allItems].sort((a, b) => b.score - a.score);
            result.topItems = sortedItems.slice(0, 3);
            result.bottomItems = [...result.allItems].sort((a, b) => a.score - b.score).slice(0, 3);
            
            // ì ìˆ˜ ë°˜ì˜¬ë¦¼
            result.highestScore = parseFloat(result.highestScore.toFixed(2));
            result.lowestScore = result.lowestScore < 5 ? parseFloat(result.lowestScore.toFixed(2)) : 0;
            
            console.log(`Parsed ${type}: count=${result.respondentCount}, avg=${result.averageScore}, items=${result.allItems.length}`);
            console.log(`Sub-category scores:`, result.subCategoryScores);
            
            return result;
        };

        // Parse trend file (ì—°ë„ë³„ ì¶”ì´)
        const parseTrendFile = (data) => {
            const result = [];
            
            // íŒŒì¼ êµ¬ì¡°:
            // í–‰ 0: ì œëª©
            // í–‰ 1: í—¤ë” (ë¹ˆì¹¸, êµì›, í•™ìƒ, í•™ë¶€ëª¨, ì§ì›)
            // í–‰ 2~: ë°ì´í„° (ë…„ë„, êµì›ì ìˆ˜, í•™ìƒì ìˆ˜, í•™ë¶€ëª¨ì ìˆ˜, ì§ì›ì ìˆ˜)
            
            for (let i = 2; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length < 5) continue;
                
                const yearCell = row[0];
                if (!yearCell) continue;
                
                // ë…„ë„ ì¶”ì¶œ (ì˜ˆ: "2025ë…„" -> "2025")
                const yearMatch = String(yearCell).match(/(\d{4})/);
                if (yearMatch) {
                    const year = yearMatch[1];
                    const teacher = parseFloat(row[1]) || 0;
                    const student = parseFloat(row[2]) || 0;
                    const parent = parseFloat(row[3]) || 0;
                    const staff = parseFloat(row[4]) || 0;
                    
                    // ì „ì²´ í‰ê·  ê³„ì‚° (ë‹¨ìˆœ í‰ê· )
                    const overall = parseFloat(((teacher + student + parent + staff) / 4).toFixed(2));
                    
                    result.push({
                        year,
                        teacher: parseFloat(teacher.toFixed(2)),
                        student: parseFloat(student.toFixed(2)),
                        parent: parseFloat(parent.toFixed(2)),
                        staff: parseFloat(staff.toFixed(2)),
                        overall
                    });
                }
            }
            
            // ë…„ë„ìˆœ ì •ë ¬
            result.sort((a, b) => parseInt(a.year) - parseInt(b.year));
            
            // ìµœê·¼ 4ê°œë…„ë§Œ ìœ ì§€
            const finalResult = result.slice(-4);
            
            console.log('Parsed trend data:', finalResult);
            
            return finalResult;
        };

        // Generate AI Insights based on data
        const generateAIInsights = (teacherData, studentData, parentData, staffData) => {
            const insights = [];
            
            // Find achievements
            if (teacherData.topItems.length > 0) {
                insights.push({
                    type: 'achievement',
                    title: 'ğŸ† êµì› ìµœê³  ì„±ê³¼',
                    content: `${teacherData.topItems[0].title.substring(0, 40)}...ì´(ê°€) ${teacherData.topItems[0].score}ì ìœ¼ë¡œ êµì› í‰ê°€ ìµœê³  ë§Œì¡±ë„ë¥¼ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤.`
                });
            }
            
            // Staff improvement
            if (staffData.averageScore > 0) {
                insights.push({
                    type: 'achievement',
                    title: 'ğŸ† ì§ì› í‰ê°€',
                    content: `ì§ì› ë§Œì¡±ë„ê°€ ${staffData.averageScore}ì ìœ¼ë¡œ ì¸¡ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`
                });
            }
            
            // Find improvements needed
            if (teacherData.bottomItems.length > 0) {
                insights.push({
                    type: 'improvement',
                    title: 'âš ï¸ ê°œì„  í•„ìš” (êµì›)',
                    content: `${teacherData.bottomItems[0].title.substring(0, 40)}...ì´(ê°€) ${teacherData.bottomItems[0].score}ì ìœ¼ë¡œ êµì› í‰ê°€ ì¤‘ ê°€ì¥ ë‚®ìŠµë‹ˆë‹¤.`
                });
            }
            
            if (studentData.bottomItems.length > 0) {
                insights.push({
                    type: 'improvement',
                    title: 'âš ï¸ ê°œì„  í•„ìš” (í•™ìƒ)',
                    content: `${studentData.bottomItems[0].title.substring(0, 40)}...ì´(ê°€) ${studentData.bottomItems[0].score}ì ìœ¼ë¡œ í•™ìƒ í‰ê°€ ì¤‘ ê°€ì¥ ë‚®ìŠµë‹ˆë‹¤.`
                });
            }
            
            // Action item
            insights.push({
                type: 'action',
                title: 'ğŸ¯ ì¦‰ì‹œ ì¡°ì¹˜',
                content: 'ë‚®ì€ ë§Œì¡±ë„ í•­ëª©ì— ëŒ€í•œ ê°œì„  ê³„íš ìˆ˜ë¦½ì´ í•„ìš”í•©ë‹ˆë‹¤.'
            });
            
            return insights;
        };

        // Generate Action Items
        const generateActionItems = (teacherData, studentData) => {
            const items = [];
            
            if (studentData.bottomItems.length > 0) {
                items.push({
                    priority: 1,
                    title: 'í•™ìƒ ë§Œì¡±ë„ ê°œì„ ',
                    details: [studentData.bottomItems[0].title.substring(0, 30) + '... ê°œì„ ', 'í•™ìƒ ì˜ê²¬ ìˆ˜ë ´ í™•ëŒ€'],
                    icon: 'ğŸ¯'
                });
            }
            
            if (teacherData.bottomItems.length > 0) {
                items.push({
                    priority: 2,
                    title: 'êµì› ì§€ì› ê°•í™”',
                    details: [teacherData.bottomItems[0].title.substring(0, 30) + '... ê°œì„ ', 'êµì› ì˜ê²¬ ë°˜ì˜'],
                    icon: 'ğŸ’¬'
                });
            }
            
            items.push({
                priority: 3,
                title: 'ìš°ìˆ˜ í”„ë¡œê·¸ë¨ í™•ëŒ€',
                details: ['ë†’ì€ ë§Œì¡±ë„ í”„ë¡œê·¸ë¨ ìœ ì§€', 'ì„±ê³µ ì‚¬ë¡€ ê³µìœ '],
                icon: 'ğŸ“š'
            });
            
            return items;
        };

        // Custom Hook: useCountUp
        const useCountUp = (end, start = 0, duration = 2000, decimals = 2) => {
            const [count, setCount] = useState(start);
            const animationFrameId = useRef(null);
            
            useEffect(() => {
                let frame = 0;
                const totalFrames = Math.round(duration / (1000 / 60));
                const easeOutExpo = t => t === 1 ? 1 : 1 - Math.pow(2, -10 * t);
                
                const counter = () => {
                    frame++;
                    const progress = easeOutExpo(frame / totalFrames);
                    const currentCount = start + (end - start) * progress;
                    setCount(parseFloat(currentCount.toFixed(decimals)));
                    
                    if (frame < totalFrames) {
                        animationFrameId.current = requestAnimationFrame(counter);
                    } else {
                        setCount(end);
                    }
                };
                
                animationFrameId.current = requestAnimationFrame(counter);
                
                return () => {
                    if (animationFrameId.current) {
                        cancelAnimationFrame(animationFrameId.current);
                    }
                };
            }, [end, start, duration, decimals]);
            
            return count;
        };

        // Icons
        const SchoolIcon = () => (
            <svg className="w-full h-full" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M12 3L1 9l11 6 9-4.91V17h2V9L12 3z"/>
                <path d="M5 13.18v4L12 21l7-3.82v-4"/>
            </svg>
        );

        const SparkleIcon = () => (
            <svg className="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 0L14.59 9.41L24 12L14.59 14.59L12 24L9.41 14.59L0 12L9.41 9.41L12 0Z"/>
            </svg>
        );

        // Premium Chart Components
        const PremiumPieChart = ({ data }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (canvasRef.current) {
                    const ctx = canvasRef.current.getContext('2d');
                    
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }

                    chartRef.current = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: data.map(d => d.name),
                            datasets: [{
                                data: data.map(d => d.value),
                                backgroundColor: data.map(d => d.color),
                                borderWidth: 4,
                                borderColor: '#ffffff',
                                hoverBorderColor: '#ffffff',
                                hoverBorderWidth: 6,
                                hoverOffset: 15,
                            }]
                        },
                        options: {
                            responsive: false,
                            maintainAspectRatio: true,
                            cutout: '60%',
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                                    titleFont: { size: 18, weight: 'bold' },
                                    bodyFont: { size: 16 },
                                    padding: 20,
                                    cornerRadius: 12,
                                    displayColors: false,
                                }
                            },
                            animation: {
                                animateRotate: true,
                                animateScale: true,
                                duration: 1500,
                                easing: 'easeInOutQuart'
                            }
                        }
                    });
                }

                return () => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                };
            }, [data]);

            return (
                <div className="flex items-center justify-center">
                    <canvas ref={canvasRef} width="400" height="400"></canvas>
                </div>
            );
        };

        const PremiumBarChart = ({ data }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (canvasRef.current) {
                    const ctx = canvasRef.current.getContext('2d');
                    
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }

                    const currentYear = data[0] ? Object.keys(data[0]).find(k => k !== 'name' && k !== '2024') : '2025';
                    const prevYear = '2024';

                    chartRef.current = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: data.map(d => d.name),
                            datasets: [
                                {
                                    label: prevYear + 'ë…„',
                                    data: data.map(d => d[prevYear] || d['2024'] || 0),
                                    backgroundColor: 'rgba(148, 163, 184, 0.8)',
                                    borderRadius: 8,
                                    borderSkipped: false,
                                },
                                {
                                    label: currentYear + 'ë…„',
                                    data: data.map(d => d[currentYear] || d['2025'] || 0),
                                    backgroundColor: (context) => {
                                        const gradient = context.chart.ctx.createLinearGradient(0, 0, 0, 400);
                                        gradient.addColorStop(0, '#818CF8');
                                        gradient.addColorStop(1, '#6366F1');
                                        return gradient;
                                    },
                                    borderRadius: 8,
                                    borderSkipped: false,
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 20,
                                        font: { size: 14, weight: '500' }
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                                    titleFont: { size: 16, weight: 'bold' },
                                    bodyFont: { size: 14 },
                                    padding: 16,
                                    cornerRadius: 12,
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    min: 3.5,
                                    max: 4.5,
                                    grid: { color: 'rgba(0, 0, 0, 0.05)' },
                                    ticks: { font: { size: 12 } }
                                },
                                x: {
                                    grid: { display: false },
                                    ticks: { font: { size: 11 } }
                                }
                            },
                            animation: {
                                duration: 1500,
                                easing: 'easeInOutQuart'
                            }
                        }
                    });
                }

                return () => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                };
            }, [data]);

            return <canvas ref={canvasRef}></canvas>;
        };

        // Premium Splash Screen
        const PremiumSplashScreen = ({ onFinished, schoolData }) => {
            const [progress, setProgress] = useState(0);

            useEffect(() => {
                const interval = setInterval(() => {
                    setProgress(prev => {
                        if (prev >= 100) {
                            clearInterval(interval);
                            setTimeout(onFinished, 500);
                            return 100;
                        }
                        return prev + 2;
                    });
                }, 30);

                return () => clearInterval(interval);
            }, [onFinished]);

            const totalParticipants = schoolData.kpiData.find(k => k.title === 'ì´ ì°¸ì—¬ ì¸ì›')?.value || 0;

            return (
                <div className="fixed inset-0 bg-gradient-to-br from-indigo-600 to-purple-600 flex flex-col items-center justify-center z-50">
                    <div className="mb-12 float">
                        <div className="w-40 h-40 text-white glow rounded-full p-4">
                            <SchoolIcon />
                        </div>
                    </div>
                    <h1 className="text-7xl font-black text-white mb-4 tracking-tight zoom-in">
                        {schoolData.academicYear} í•™êµí‰ê°€
                    </h1>
                    <p className="text-4xl text-white/80 font-medium mb-4 fade-in-up stagger-2">
                        {schoolData.semester} ë¶„ì„ ëŒ€ì‹œë³´ë“œ
                    </p>
                    <div className="flex items-center gap-4 text-white/90 text-2xl mb-16 fade-in-up stagger-3">
                        <SparkleIcon />
                        <span className="font-medium">{totalParticipants.toLocaleString()}ëª…ì˜ ì†Œì¤‘í•œ ì˜ê²¬</span>
                        <SparkleIcon />
                    </div>
                    <div className="w-80 mx-auto fade-in-up stagger-4">
                        <div className="h-3 bg-white/20 rounded-full overflow-hidden">
                            <div 
                                className="h-full bg-white rounded-full shimmer transition-all duration-300"
                                style={{ width: `${progress}%` }}
                            ></div>
                        </div>
                        <p className="text-white/70 text-center mt-4 text-lg">{progress}% ë¡œë”© ì¤‘...</p>
                    </div>
                </div>
            );
        };

        // Header Component
        const PremiumHeader = ({ schoolData, onEnterPresentation, onOpenDataEditor }) => {
            const handleFullScreen = () => { 
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        console.error(`Error: ${err.message}`);
                    }); 
                } else {
                    document.exitFullscreen();
                }
            };
            
            return (
                <header className="glass sticky top-0 z-50 px-8 py-4">
                    <div className="max-w-7xl mx-auto flex justify-between items-center">
                        <div className="flex items-center gap-4">
                            <div className="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center text-white shadow-lg">
                                <SchoolIcon />
                            </div>
                            <div>
                                <h1 className="text-2xl font-bold text-white">{schoolData.schoolName}</h1>
                                <p className="text-sm text-white/70">{schoolData.academicYear}í•™ë…„ë„ {schoolData.semester} í‰ê°€ ë¶„ì„ ëŒ€ì‹œë³´ë“œ</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-3">
                            <button 
                                onClick={onOpenDataEditor}
                                className="btn-premium px-6 py-3 bg-white/20 hover:bg-white/30 text-white rounded-xl font-semibold backdrop-blur-xl transition-all"
                            >
                                âœï¸ ë°ì´í„° ì„¤ì •
                            </button>
                            <button 
                                onClick={handleFullScreen}
                                className="btn-premium p-3 bg-white/20 hover:bg-white/30 text-white rounded-xl backdrop-blur-xl transition-all"
                            >
                                â›¶
                            </button>
                            <button 
                                onClick={() => onEnterPresentation()}
                                className="btn-premium px-6 py-3 bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white rounded-xl font-bold shadow-lg transition-all"
                            >
                                ğŸ¬ ë°œí‘œ ì‹œì‘
                            </button>
                        </div>
                    </div>
                </header>
            );
        };

        // KPI Card Component
        const PremiumKpiCard = ({ data, onDetailClick, delay = 0 }) => {
            const animatedValue = useCountUp(data.value, 0, 2000, data.total ? 2 : (data.unit === '%' ? 1 : 0));
            
            return (
                <div 
                    className="premium-card stat-card p-8 cursor-pointer fade-in-up card-3d"
                    style={{ animationDelay: `${delay}ms` }}
                    onClick={onDetailClick}
                >
                    <div className="flex justify-between items-start mb-6">
                        <div>
                            <p className="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-2">
                                {data.title}
                            </p>
                            <div className="flex items-baseline gap-2">
                                <span className="text-5xl font-black text-gray-900 number-counter">
                                    {animatedValue.toLocaleString(undefined, { 
                                        minimumFractionDigits: data.total ? 2 : (data.unit === '%' ? 1 : 0), 
                                        maximumFractionDigits: data.total ? 2 : (data.unit === '%' ? 1 : 0)
                                    })}
                                </span>
                                {data.total && (
                                    <span className="text-2xl font-bold text-gray-400">
                                        /{data.total.toFixed(2)}
                                    </span>
                                )}
                                {data.unit && (
                                    <span className="text-2xl font-bold text-gray-400">{data.unit}</span>
                                )}
                            </div>
                        </div>
                        <div className="text-5xl pulse-slow">
                            {data.icon}
                        </div>
                    </div>
                    <div className="flex items-center gap-2">
                        <span className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-bold ${
                            data.change >= 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
                        }`}>
                            {data.change >= 0 ? 'â–²' : 'â–¼'} {data.change > 0 ? '+' : ''}{typeof data.change === 'number' ? data.change.toFixed(2) : data.change}
                        </span>
                        <span className="text-sm text-gray-500">ì „ë…„ ëŒ€ë¹„</span>
                    </div>
                </div>
            );
        };

        // Category Chart Card
        const CategoryChartCard = ({ data, academicYear }) => {
            return (
                <div className="glass-white rounded-3xl p-8 h-full fade-in-up" style={{ animationDelay: '300ms' }}>
                    <div className="flex items-center justify-between mb-8">
                        <div>
                            <h3 className="text-2xl font-bold text-gray-900 mb-2">ì¹´í…Œê³ ë¦¬ë³„ ë§Œì¡±ë„</h3>
                            <p className="text-gray-500">{parseInt(academicYear) - 1} vs {academicYear} ë¹„êµ ë¶„ì„</p>
                        </div>
                        <div className="inline-flex items-center px-4 py-2 rounded-full text-sm font-bold bg-indigo-100 text-indigo-700">
                            {data.length}ê°œ í•­ëª©
                        </div>
                    </div>
                    <div className="h-96">
                        <PremiumBarChart data={data} />
                    </div>
                </div>
            );
        };

        // AI Insights Panel
        const PremiumAiInsightsPanel = ({ aiInsights, voices }) => {
            return (
                <div className="glass-white rounded-3xl p-8 h-full flex flex-col fade-in-up" style={{ animationDelay: '400ms' }}>
                    <div className="flex items-center gap-3 mb-6">
                        <div className="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center">
                            <span className="text-xl">ğŸ¤–</span>
                        </div>
                        <h3 className="text-2xl font-bold text-gray-900">AI ì¸ì‚¬ì´íŠ¸</h3>
                    </div>
                    
                    <div className="flex-1 space-y-4 overflow-y-auto pr-2 mb-6">
                        {aiInsights.length > 0 ? aiInsights.map((insight, index) => (
                            <div 
                                key={index}
                                className="premium-card p-6 hover:shadow-2xl transition-all"
                            >
                                <h4 className="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                                    {insight.title}
                                </h4>
                                <p className="text-gray-600 leading-relaxed text-sm">
                                    {insight.content}
                                </p>
                            </div>
                        )) : (
                            <div className="text-center text-gray-500 py-8">
                                <p>ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ë©´ AI ì¸ì‚¬ì´íŠ¸ê°€ ìƒì„±ë©ë‹ˆë‹¤.</p>
                            </div>
                        )}
                    </div>

                    {voices && voices.length > 0 && (
                        <div className="border-t pt-6">
                            <h4 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                                <span>ğŸ’¬</span> ìƒìƒí•œ ëª©ì†Œë¦¬
                            </h4>
                            <div className="space-y-3">
                                {voices.map((voice, index) => (
                                    <div key={index} className="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-4">
                                        <p className="text-gray-800 font-medium mb-2 flex items-start gap-2">
                                            <span className="text-xl">{voice.emoji}</span>
                                            <span className="flex-1">{voice.text}</span>
                                        </p>
                                        <p className="text-sm text-gray-500 text-right">- {voice.source}</p>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Dashboard Component
        const PremiumDashboard = ({ schoolData, onEnterPresentation, onOpenDataEditor }) => {
            
            const getResponseRate = (group) => {
                const map = { 'êµì›': 'teacher', 'í•™ìƒ': 'student', 'í•™ë¶€ëª¨': 'parent', 'ì§ì›': 'staff' };
                return schoolData.responseRates[map[group]] || 0;
            };

            return (
                <div className="min-h-screen pb-12">
                    <PremiumHeader 
                        schoolData={schoolData} 
                        onEnterPresentation={onEnterPresentation}
                        onOpenDataEditor={onOpenDataEditor}
                    />
                    
                    <main className="max-w-7xl mx-auto px-8 py-12">
                        {/* Hero Section */}
                        <div className="text-center mb-16 fade-in-up">
                            <h2 className="display-2 text-white mb-4">
                                {schoolData.academicYear} í•™êµ í‰ê°€ ë¦¬í¬íŠ¸ 
                            </h2>
                            <p className="text-xl text-white/80 font-medium">
                                ë°ì´í„° ê¸°ë°˜ì˜ ì •í™•í•œ ì¸ì‚¬ì´íŠ¸ì™€ ê°œì„  ë°©í–¥
                            </p>
                        </div>

                        {/* KPI Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                            {schoolData.kpiData.map((kpi, index) => (
                                <PremiumKpiCard 
                                    key={index}
                                    data={kpi}
                                    delay={index * 100}
                                    onDetailClick={() => onEnterPresentation(kpi.targetSlide)}
                                />
                            ))}
                        </div>

                        {/* Charts & Insights */}
                        <div className="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-12">
                            <div className="lg:col-span-3">
                                <CategoryChartCard data={schoolData.categoryData} academicYear={schoolData.academicYear} />
                            </div>
                            <div className="lg:col-span-2">
                                <PremiumAiInsightsPanel 
                                    aiInsights={schoolData.aiInsights}
                                    voices={schoolData.voices}
                                />
                            </div>
                        </div>

                        {/* Respondents Overview */}
                        <div className="glass-white rounded-3xl p-8 fade-in-up" style={{ animationDelay: '500ms' }}>
                            <h3 className="text-2xl font-bold text-gray-900 mb-8">ì‘ë‹µì êµ¬ì„±</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                                <div className="w-full max-w-sm mx-auto">
                                    <PremiumPieChart data={schoolData.respondentData} />
                                </div>
                                <div className="space-y-4">
                                    {schoolData.respondentData.map((item, index) => (
                                        <div key={index} className="flex items-center justify-between p-4 bg-gradient-to-r from-gray-50 to-white rounded-xl">
                                            <div className="flex items-center gap-4">
                                                <div 
                                                    className="w-4 h-4 rounded-full shadow-lg"
                                                    style={{ backgroundColor: item.color }}
                                                ></div>
                                                <span className="font-semibold text-gray-800">{item.name}</span>
                                            </div>
                                            <div className="flex items-center gap-4">
                                                <span className="text-sm font-semibold text-gray-500 bg-gray-100 px-2 py-1 rounded-md">
                                                    ì‘ë‹µë¥  {getResponseRate(item.name)}%
                                                </span>
                                                <span className="text-3xl font-black text-gray-900 number-counter">
                                                    {item.value.toLocaleString()}
                                                    <span className="text-lg text-gray-500 ml-1">ëª…</span>
                                                </span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        // ============================================
        // PRESENTATION SLIDES
        // ============================================

        const SlideWrapper = ({ children, className = '' }) => (
            <div className={`w-full h-full flex flex-col justify-center items-center text-center p-12 ${className}`}>
                {children}
            </div>
        );

        // Slide 0: Title Slide
        const TitleSlide = ({ schoolData }) => {
            const totalParticipants = schoolData.kpiData.find(k => k.title === 'ì´ ì°¸ì—¬ ì¸ì›')?.value || 0;
            return (
                <SlideWrapper>
                    <div className="zoom-in">
                        <div className="inline-block p-10 bg-white/10 backdrop-blur-xl rounded-3xl border border-white/20 mb-12 float glow">
                            <div className="w-40 h-40 text-white">
                                <SchoolIcon />
                            </div>
                        </div>
                        <h1 className="display-1 text-white mb-8">
                            {schoolData.academicYear} í•™êµ í‰ê°€
                        </h1>
                        <p className="text-6xl text-white/90 font-bold mb-6 fade-in-up stagger-2">
                            <span className="text-yellow-300">{totalParticipants.toLocaleString()}</span>ëª…ì˜ ì´ì•¼ê¸°
                        </p>
                        <p className="text-4xl text-white/70 font-medium mb-8 fade-in-up stagger-3">
                            {schoolData.semester} ë¶„ì„ ë¦¬í¬íŠ¸
                        </p>
                        <div className="flex items-center justify-center gap-6 text-white/70 text-3xl fade-in-up stagger-4">
                            <span className="sparkle">âœ¨</span>
                            <span>ë°ì´í„° ê¸°ë°˜ ì¸ì‚¬ì´íŠ¸</span>
                            <span className="sparkle">âœ¨</span>
                        </div>
                    </div>
                </SlideWrapper>
            );
        };

        // Slide 1: Overall Score Slide
        const OverallScoreSlide = ({ schoolData }) => {
            const overallKpi = schoolData.kpiData.find(k => k.title === 'ì¢…í•© ë§Œì¡±ë„');
            const score = useCountUp(overallKpi.value, 0, 2500, 2);
            const percentage = useCountUp((overallKpi.value / overallKpi.total) * 100, 0, 2500, 1);
            
            return (
                <SlideWrapper>
                    <div className="fade-in-scale">
                        <p className="text-4xl text-white/70 font-semibold mb-10">â­ ì¢…í•© ë§Œì¡±ë„ â­</p>
                        <div className="mb-16">
                            <span className="display-1 text-white number-counter font-black glow" style={{textShadow: '0 0 60px rgba(255,255,255,0.5)'}}>
                                {score.toFixed(2)}
                            </span>
                            <span className="text-7xl text-white/50 font-bold">
                                /{overallKpi.total.toFixed(1)}
                            </span>
                        </div>
                        <div className="w-full max-w-4xl mx-auto mb-12">
                            <div className="h-10 bg-white/20 rounded-full overflow-hidden backdrop-blur-xl shadow-2xl">
                                <div 
                                    className="h-full bg-gradient-to-r from-green-400 via-emerald-400 to-teal-500 rounded-full progress-animate"
                                    style={{ width: `${percentage}%` }}
                                ></div>
                            </div>
                            <p className="text-4xl text-white/80 mt-6 font-bold">{percentage.toFixed(1)}% ë‹¬ì„±</p>
                        </div>
                        <div className={`inline-block px-12 py-6 backdrop-blur-xl rounded-3xl border-2 slide-up-bounce ${overallKpi.change >= 0 ? 'bg-green-500/20 border-green-400/50' : 'bg-orange-500/20 border-orange-400/50'}`}>
                            <p className={`text-4xl font-bold ${overallKpi.change >= 0 ? 'text-green-300' : 'text-orange-300'}`}>
                                {overallKpi.change >= 0 ? 'ğŸ“ˆ â–²' : 'ğŸ“‰ â–¼'} ì „ë…„ ëŒ€ë¹„ {overallKpi.change >= 0 ? '+' : ''}{overallKpi.change.toFixed(2)}ì 
                            </p>
                        </div>
                    </div>
                </SlideWrapper>
            );
        };

        // Slide 2: Participants Slide
        const ParticipantsSlide = ({ schoolData }) => {
            const total = schoolData.respondentData.reduce((sum, item) => sum + item.value, 0);
            
            return (
                <SlideWrapper>
                    <div className="w-full max-w-6xl fade-in-scale">
                        <h2 className="text-6xl font-bold text-white mb-16">ğŸ‘¥ ì‘ë‹µì êµ¬ì„±</h2>
                        <div className="grid grid-cols-2 gap-16 items-center">
                            <div className="flex items-center justify-center zoom-in" style={{ width: '400px', height: '400px', margin: '0 auto' }}>
                                <PremiumPieChart data={schoolData.respondentData} />
                            </div>
                            <div className="space-y-6 text-left">
                                {schoolData.respondentData.map((d, index) => (
                                    <div 
                                        key={index} 
                                        className={`flex items-center justify-between p-6 bg-white/10 backdrop-blur-xl rounded-2xl border border-white/20 slide-up-bounce card-3d`}
                                        style={{ animationDelay: `${index * 150}ms` }}
                                    >
                                        <div className="flex items-center gap-4">
                                            <div 
                                                className="w-8 h-8 rounded-full shadow-lg"
                                                style={{ backgroundColor: d.color }}
                                            ></div>
                                            <span className="text-3xl font-bold text-white">{d.name}</span>
                                        </div>
                                        <span className="text-5xl font-black text-white number-counter">
                                            {d.value.toLocaleString()}
                                            <span className="text-2xl text-white/70 ml-2">ëª…</span>
                                        </span>
                                    </div>
                                ))}
                                <div className="mt-8 p-6 bg-gradient-to-r from-indigo-500/30 to-purple-500/30 rounded-2xl border border-indigo-400/30 fade-in-up stagger-5">
                                    <p className="text-3xl text-white font-bold text-center">
                                        ì´ <span className="text-5xl text-yellow-300">{total.toLocaleString()}</span>ëª… ì°¸ì—¬ ğŸ‰
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </SlideWrapper>
            );
        };

        // Slide 3: Response Rate Slide (Updated to Group Breakdown)
        const ResponseRateSlide = ({ schoolData }) => {
            const { responseRates, respondentData } = schoolData;
            
            const groups = [
                { id: 'teacher', name: 'êµì›', color: '#6366F1', icon: 'ğŸ‘¨â€ğŸ«' },
                { id: 'student', name: 'í•™ìƒ', color: '#EC4899', icon: 'ğŸ“' },
                { id: 'parent', name: 'í•™ë¶€ëª¨', color: '#10B981', icon: 'ğŸ‘ª' },
                { id: 'staff', name: 'ì§ì›', color: '#F59E0B', icon: 'ğŸ’¼' }
            ];

            return (
                <SlideWrapper>
                    <div className="w-full max-w-6xl fade-in-up">
                        <h2 className="text-6xl font-bold text-white mb-16">ğŸ“Š ê·¸ë£¹ë³„ ì‹¤ì œ ì‘ë‹µë¥ </h2>
                        
                        <div className="grid grid-cols-2 gap-8">
                            {groups.map((group, index) => {
                                const rate = responseRates[group.id] || 0;
                                const animatedRate = useCountUp(rate, 0, 1500, 1);
                                
                                return (
                                    <div 
                                        key={group.id}
                                        className="bg-white/10 backdrop-blur-xl rounded-3xl p-8 border border-white/20 slide-up-bounce card-3d"
                                        style={{ animationDelay: `${index * 150}ms` }}
                                    >
                                        <div className="flex items-center justify-between mb-6">
                                            <div className="flex items-center gap-4">
                                                <span className="text-4xl">{group.icon}</span>
                                                <h3 className="text-3xl font-bold text-white">{group.name}</h3>
                                            </div>
                                            <span className="text-5xl font-black text-white number-counter">
                                                {animatedRate.toFixed(1)}%
                                            </span>
                                        </div>
                                        
                                        <div className="h-6 bg-white/20 rounded-full overflow-hidden mb-2">
                                            <div 
                                                className="h-full rounded-full progress-animate relative"
                                                style={{ 
                                                    width: `${Math.min(rate, 100)}%`,
                                                    backgroundColor: group.color 
                                                }}
                                            >
                                                <div className="absolute inset-0 bg-white/30 animate-pulse"></div>
                                            </div>
                                        </div>
                                        <p className="text-right text-white/60 text-lg">
                                            ì‘ë‹µ ì™„ë£Œ
                                        </p>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </SlideWrapper>
            );
        };

        // Slide 4: Category Change Slide
        const CategoryChangeSlide = ({ schoolData }) => {
            const { categoryData, academicYear } = schoolData;
            const prevYear = String(parseInt(academicYear) - 1);
            
            return (
                <SlideWrapper>
                    <div className="w-full max-w-6xl fade-in-scale">
                        <h2 className="text-5xl font-bold text-white mb-12">ğŸ“Š ì¹´í…Œê³ ë¦¬ë³„ ë§Œì¡±ë„ ë³€í™”</h2>
                        <div className="grid grid-cols-2 gap-5">
                            {categoryData.map((cat, idx) => {
                                const currentScore = cat[academicYear] || cat['2025'] || 0;
                                const prevScore = cat[prevYear] || cat['2024'] || 0;
                                const change = (currentScore - prevScore).toFixed(2);
                                const isPositive = parseFloat(change) >= 0;
                                return (
                                    <div 
                                        key={idx} 
                                        className={`bg-white/10 backdrop-blur-xl rounded-2xl p-5 border border-white/20 slide-up-bounce card-3d`}
                                        style={{ animationDelay: `${idx * 100}ms` }}
                                    >
                                        <div className="flex justify-between items-center">
                                            <p className="text-xl text-white font-semibold">{cat.name}</p>
                                            <div className="flex items-center gap-4">
                                                <span className="text-white/60 text-lg">{prevScore.toFixed(2)}</span>
                                                <span className="text-white/40 text-2xl">â†’</span>
                                                <span className="text-3xl font-bold text-white">{currentScore.toFixed(2)}</span>
                                                <span className={`text-lg px-3 py-1 rounded-full ${isPositive ? 'bg-green-500/30 text-green-300' : 'bg-red-500/30 text-red-300'}`}>
                                                    {isPositive ? '+' : ''}{change}
                                                </span>
                                            </div>
                                        </div>
                                        <div className="mt-4 h-3 bg-white/20 rounded-full overflow-hidden">
                                            <div 
                                                className="h-full bg-gradient-to-r from-indigo-400 to-purple-500 rounded-full progress-animate"
                                                style={{ width: `${(currentScore / 5) * 100}%` }}
                                            ></div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </SlideWrapper>
            );
        };

        // Slide 5: Group Comparison Slide
        const ComparisonSlide = ({ schoolData }) => {
            const { comparisonData } = schoolData;
            
            const groups = [
                { key: 'teacher', name: 'êµì›', color: '#6366F1', data: comparisonData.teacher },
                { key: 'student', name: 'í•™ìƒ', color: '#EC4899', data: comparisonData.student },
                { key: 'parent', name: 'í•™ë¶€ëª¨', color: '#10B981', data: comparisonData.parent },
                { key: 'staff', name: 'ì§ì›', color: '#F59E0B', data: comparisonData.staff },
            ];
            
            return (
                <SlideWrapper>
                    <div className="w-full max-w-6xl fade-in-scale">
                        <h2 className="text-5xl font-bold text-white mb-12">ğŸ… ê·¸ë£¹ë³„ ë§Œì¡±ë„ ë¹„êµ</h2>
                        <div className="grid grid-cols-4 gap-6">
                            {groups.map((group, idx) => (
                                <div 
                                    key={idx}
                                    className={`bg-white/10 backdrop-blur-xl rounded-3xl p-6 border border-white/20 flip-in`}
                                    style={{ animationDelay: `${idx * 150}ms` }}
                                >
                                    <div className="flex items-center gap-3 mb-6">
                                        <div className="w-5 h-5 rounded-full" style={{ backgroundColor: group.color }}></div>
                                        <h3 className="text-2xl font-bold text-white">{group.name}</h3>
                                    </div>
                                    <div className="text-center mb-6">
                                        <p className="text-6xl font-black text-white number-counter glow">{group.data.average.toFixed(2)}</p>
                                        <p className="text-lg text-white/60 mt-2">í‰ê·  ì ìˆ˜</p>
                                    </div>
                                    <div className="space-y-3">
                                        <div className="bg-green-500/20 p-3 rounded-xl">
                                            <p className="text-sm text-white/60">ìµœê³ ì </p>
                                            <p className="text-2xl font-bold text-green-300">{group.data.highest.toFixed(2)}</p>
                                        </div>
                                        <div className="bg-orange-500/20 p-3 rounded-xl">
                                            <p className="text-sm text-white/60">ìµœì €ì </p>
                                            <p className="text-2xl font-bold text-orange-300">{group.data.lowest.toFixed(2)}</p>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </SlideWrapper>
            );
        };

        // Slide 6: Top Items Slide (êµì›)
        const TopItemsTeacherSlide = ({ schoolData }) => {
            const { topBottomItems } = schoolData;
            
            return (
                <SlideWrapper>
                    <div className="w-full max-w-5xl fade-in-scale">
                        <h2 className="text-5xl font-bold text-white mb-4">ğŸ† TOP 3 í•­ëª© (êµì›)</h2>
                        <p className="text-2xl text-white/60 mb-12">ê°€ì¥ ë†’ì€ ë§Œì¡±ë„ë¥¼ ê¸°ë¡í•œ í•­ëª©</p>
                        <div className="space-y-6">
                            {topBottomItems.teacherTop.length > 0 ? topBottomItems.teacherTop.map((item, idx) => (
                                <div 
                                    key={idx}
                                    className={`bg-gradient-to-r from-green-500/20 to-emerald-500/20 backdrop-blur-xl rounded-2xl p-8 border border-green-400/30 slide-in-right`}
                                    style={{ animationDelay: `${idx * 200}ms` }}
                                >
                                    <div className="flex items-center justify-between gap-6">
                                        <div className="flex items-center gap-6">
                                            <span className="text-5xl">{idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : 'ğŸ¥‰'}</span>
                                            <p className="text-2xl text-white/90 text-left">{item.title}</p>
                                        </div>
                                        <span className="text-4xl font-black text-green-300 whitespace-nowrap">{item.score}</span>
                                    </div>
                                </div>
                            )) : (
                                <div className="text-center text-white/60 py-12">
                                    <p className="text-2xl">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ë©´ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                                </div>
                            )}
                        </div>
                    </div>
                </SlideWrapper>
            );
        };

        // Slide 7: Top Items Slide (í•™ìƒ)
        const TopItemsStudentSlide = ({ schoolData }) => {
            const { topBottomItems } = schoolData;
            
            return (
                <SlideWrapper>
                    <div className="w-full max-w-5xl fade-in-scale">
                        <h2 className="text-5xl font-bold text-white mb-4">ğŸ† TOP 3 í•­ëª© (í•™ìƒ)</h2>
                        <p className="text-2xl text-white/60 mb-12">í•™ìƒë“¤ì´ ê°€ì¥ ë§Œì¡±í•œ í•­ëª©</p>
                        <div className="space-y-6">
                            {topBottomItems.studentTop.length > 0 ? topBottomItems.studentTop.map((item, idx) => (
                                <div 
                                    key={idx}
                                    className={`bg-gradient-to-r from-green-500/20 to-emerald-500/20 backdrop-blur-xl rounded-2xl p-8 border border-green-400/30 slide-in-right`}
                                    style={{ animationDelay: `${idx * 200}ms` }}
                                >
                                    <div className="flex items-center justify-between gap-6">
                                        <div className="flex items-center gap-6">
                                            <span className="text-5xl">{idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : 'ğŸ¥‰'}</span>
                                            <p className="text-2xl text-white/90 text-left">{item.title}</p>
                                        </div>
                                        <span className="text-4xl font-black text-green-300 whitespace-nowrap">{item.score}</span>
                                    </div>
                                </div>
                            )) : (
                                <div className="text-center text-white/60 py-12">
                                    <p className="text-2xl">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ë©´ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                                </div>
                            )}
                        </div>
                    </div>
                </SlideWrapper>
            );
        };

        // Slide 8: Improvement Items Slide (êµì›)
        const ImprovementTeacherSlide = ({ schoolData }) => {
            const { topBottomItems } = schoolData;
            
            return (
                <SlideWrapper>
                    <div className="w-full max-w-5xl fade-in-scale">
                        <h2 className="text-5xl font-bold text-white mb-4">âš ï¸ ê°œì„  í•„ìš” í•­ëª© (êµì›)</h2>
                        <p className="text-2xl text-white/60 mb-12">êµì›ì´ ê°€ì¥ ë‚®ê²Œ í‰ê°€í•œ ì˜ì—­</p>
                        <div className="space-y-6">
                            {topBottomItems.teacherBottom.length > 0 ? topBottomItems.teacherBottom.map((item, idx) => (
                                <div 
                                    key={idx}
                                    className={`bg-gradient-to-r from-red-500/20 to-pink-500/20 backdrop-blur-xl rounded-2xl p-8 border border-red-400/30 slide-in-right`}
                                    style={{ animationDelay: `${idx * 200}ms` }}
                                >
                                    <div className="flex items-center justify-between gap-6">
                                        <div className="flex items-center gap-6">
                                            <span className="text-5xl">ğŸ‘</span>
                                            <p className="text-2xl text-white/90 text-left">{item.title}</p>
                                        </div>
                                        <span className="text-4xl font-black text-red-300 whitespace-nowrap">{item.score}</span>
                                    </div>
                                </div>
                            )) : (
                                <div className="text-center text-white/60 py-12">
                                    <p className="text-2xl">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ë©´ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                                </div>
                            )}
                        </div>
                    </div>
                </SlideWrapper>
            );
        };

        // Slide 9: Improvement Items Slide (í•™ìƒ)
        const ImprovementStudentSlide = ({ schoolData }) => {
            const { topBottomItems } = schoolData;
            
            return (
                <SlideWrapper>
                    <div className="w-full max-w-5xl fade-in-scale">
                        <h2 className="text-5xl font-bold text-white mb-4">âš ï¸ ê°œì„  í•„ìš” í•­ëª© (í•™ìƒ)</h2>
                        <p className="text-2xl text-white/60 mb-12">í•™ìƒì´ ê°€ì¥ ë‚®ê²Œ í‰ê°€í•œ ì˜ì—­</p>
                        <div className="space-y-6">
                            {topBottomItems.studentBottom.length > 0 ? topBottomItems.studentBottom.map((item, idx) => (
                                <div 
                                    key={idx}
                                    className={`bg-gradient-to-r from-red-500/20 to-pink-500/20 backdrop-blur-xl rounded-2xl p-8 border border-red-400/30 slide-in-right`}
                                    style={{ animationDelay: `${idx * 200}ms` }}
                                >
                                    <div className="flex items-center justify-between gap-6">
                                        <div className="flex items-center gap-6">
                                            <span className="text-5xl">ğŸ˜Ÿ</span>
                                            <p className="text-2xl text-white/90 text-left">{item.title}</p>
                                        </div>
                                        <span className="text-4xl font-black text-red-300 whitespace-nowrap">{item.score}</span>
                                    </div>
                                </div>
                            )) : (
                                <div className="text-center text-white/60 py-12">
                                    <p className="text-2xl">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ë©´ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                                </div>
                            )}
                        </div>
                    </div>
                </SlideWrapper>
            );
        };

        // Slide 10: Trend Slide
        const TrendSlide = ({ schoolData }) => {
            const { trendData } = schoolData;
            
            return (
                <SlideWrapper>
                    <div className="w-full max-w-6xl fade-in-scale">
                        <h2 className="text-5xl font-bold text-white mb-12">ğŸ“ˆ ì—°ë„ë³„ ë§Œì¡±ë„ ì¶”ì´</h2>
                        <div className="grid grid-cols-4 gap-6">
                            {trendData.map((data, idx) => (
                                <div 
                                    key={idx} 
                                    className={`bg-white/10 backdrop-blur-xl rounded-3xl p-6 border border-white/20 rotate-in card-3d`}
                                    style={{ animationDelay: `${idx * 150}ms` }}
                                >
                                    <p className="text-4xl font-black text-white mb-6">{data.year}</p>
                                    <div className="space-y-4">
                                        <div className="bg-indigo-500/20 p-3 rounded-xl">
                                            <p className="text-sm text-indigo-300">êµì›</p>
                                            <p className="text-2xl font-bold text-white">{data.teacher.toFixed(2)}</p>
                                        </div>
                                        <div className="bg-pink-500/20 p-3 rounded-xl">
                                            <p className="text-sm text-pink-300">í•™ìƒ</p>
                                            <p className="text-2xl font-bold text-white">{data.student.toFixed(2)}</p>
                                        </div>
                                        <div className="bg-emerald-500/20 p-3 rounded-xl">
                                            <p className="text-sm text-emerald-300">í•™ë¶€ëª¨</p>
                                            <p className="text-2xl font-bold text-white">{data.parent.toFixed(2)}</p>
                                        </div>
                                        <div className="bg-amber-500/20 p-3 rounded-xl">
                                            <p className="text-sm text-amber-300">ì§ì›</p>
                                            <p className="text-2xl font-bold text-white">{data.staff.toFixed(2)}</p>
                                        </div>
                                        <div className="pt-3 border-t border-white/20">
                                            <p className="text-sm text-white/60">í‰ê· </p>
                                            <p className="text-3xl font-black text-yellow-300">{data.overall.toFixed(2)}</p>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </SlideWrapper>
            );
        };

        // Slide 11: Trend Line Chart Slide
        const TrendBarChartSlide = ({ schoolData }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);
            const { trendData } = schoolData;

            useEffect(() => {
                if (canvasRef.current && trendData.length > 0) {
                    const ctx = canvasRef.current.getContext('2d');
                    
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }

                    chartRef.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: trendData.map(d => d.year + 'ë…„'),
                            datasets: [
                                {
                                    label: 'êµì›',
                                    data: trendData.map(d => d.teacher),
                                    borderColor: 'rgba(99, 102, 241, 1)',
                                    backgroundColor: 'rgba(99, 102, 241, 0.2)',
                                    borderWidth: 4,
                                    pointRadius: 8,
                                    pointHoverRadius: 12,
                                    pointBackgroundColor: 'rgba(99, 102, 241, 1)',
                                    pointBorderColor: '#fff',
                                    pointBorderWidth: 3,
                                    tension: 0.3,
                                    fill: false,
                                },
                                {
                                    label: 'í•™ìƒ',
                                    data: trendData.map(d => d.student),
                                    borderColor: 'rgba(236, 72, 153, 1)',
                                    backgroundColor: 'rgba(236, 72, 153, 0.2)',
                                    borderWidth: 4,
                                    pointRadius: 8,
                                    pointHoverRadius: 12,
                                    pointBackgroundColor: 'rgba(236, 72, 153, 1)',
                                    pointBorderColor: '#fff',
                                    pointBorderWidth: 3,
                                    tension: 0.3,
                                    fill: false,
                                },
                                {
                                    label: 'í•™ë¶€ëª¨',
                                    data: trendData.map(d => d.parent),
                                    borderColor: 'rgba(16, 185, 129, 1)',
                                    backgroundColor: 'rgba(16, 185, 129, 0.2)',
                                    borderWidth: 4,
                                    pointRadius: 8,
                                    pointHoverRadius: 12,
                                    pointBackgroundColor: 'rgba(16, 185, 129, 1)',
                                    pointBorderColor: '#fff',
                                    pointBorderWidth: 3,
                                    tension: 0.3,
                                    fill: false,
                                },
                                {
                                    label: 'ì§ì›',
                                    data: trendData.map(d => d.staff),
                                    borderColor: 'rgba(245, 158, 11, 1)',
                                    backgroundColor: 'rgba(245, 158, 11, 0.2)',
                                    borderWidth: 4,
                                    pointRadius: 8,
                                    pointHoverRadius: 12,
                                    pointBackgroundColor: 'rgba(245, 158, 11, 1)',
                                    pointBorderColor: '#fff',
                                    pointBorderWidth: 3,
                                    tension: 0.3,
                                    fill: false,
                                },
                                {
                                    label: 'í‰ê· ',
                                    data: trendData.map(d => d.overall),
                                    borderColor: 'rgba(139, 92, 246, 1)',
                                    backgroundColor: 'rgba(139, 92, 246, 0.2)',
                                    borderWidth: 5,
                                    pointRadius: 10,
                                    pointHoverRadius: 14,
                                    pointBackgroundColor: 'rgba(139, 92, 246, 1)',
                                    pointBorderColor: '#fff',
                                    pointBorderWidth: 3,
                                    tension: 0.3,
                                    fill: false,
                                    borderDash: [],
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false,
                            },
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: {
                                        color: 'rgba(255, 255, 255, 0.9)',
                                        usePointStyle: true,
                                        pointStyle: 'circle',
                                        padding: 20,
                                        font: { size: 16, weight: '600' }
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                                    titleFont: { size: 18, weight: 'bold' },
                                    bodyFont: { size: 16 },
                                    padding: 16,
                                    cornerRadius: 12,
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': ' + context.raw.toFixed(2) + 'ì ';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    min: 3.0,
                                    max: 5.0,
                                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                    ticks: { 
                                        color: 'rgba(255, 255, 255, 0.8)',
                                        font: { size: 14, weight: '500' },
                                        callback: function(value) {
                                            return value.toFixed(1);
                                        }
                                    }
                                },
                                x: {
                                    grid: { color: 'rgba(255, 255, 255, 0.05)' },
                                    ticks: { 
                                        color: 'rgba(255, 255, 255, 0.9)',
                                        font: { size: 18, weight: '700' }
                                    }
                                }
                            },
                            animation: {
                                duration: 1500,
                                easing: 'easeInOutQuart'
                            }
                        }
                    });
                }

                return () => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                };
            }, [trendData]);

            return (
                <SlideWrapper>
                    <div className="w-full max-w-6xl fade-in-scale">
                        <h2 className="text-5xl font-bold text-white mb-4">ğŸ“ˆ ì—°ë„ë³„ ë§Œì¡±ë„ ì¶”ì´ ê·¸ë˜í”„</h2>
                        <p className="text-2xl text-white/60 mb-10">ê·¸ë£¹ë³„ ì—°ë„ë³„ ë§Œì¡±ë„ ë³€í™”</p>
                        <div className="bg-white/10 backdrop-blur-xl rounded-3xl p-8 border border-white/20" style={{ height: '500px' }}>
                            <canvas ref={canvasRef}></canvas>
                        </div>
                    </div>
                </SlideWrapper>
            );
        };

        // Slide 12: Insights Slide
        const InsightsSlide = ({ schoolData }) => {
            const { aiInsights } = schoolData;
            
            const getTypeStyle = (type) => {
                switch(type) {
                    case 'achievement': return 'from-green-500/20 to-emerald-500/20 border-green-400/30';
                    case 'improvement': return 'from-red-500/20 to-pink-500/20 border-red-400/30';
                    case 'action': return 'from-purple-500/20 to-pink-500/20 border-purple-400/30';
                    default: return 'from-blue-500/20 to-cyan-500/20 border-blue-400/30';
                }
            };
            
            return (
                <SlideWrapper>
                    <div className="w-full max-w-5xl fade-in-scale">
                        <h2 className="text-5xl font-bold text-white mb-12">ğŸ¤– AI í•µì‹¬ ì¸ì‚¬ì´íŠ¸</h2>
                        <div className="space-y-5">
                            {aiInsights.length > 0 ? aiInsights.map((insight, idx) => (
                                <div 
                                    key={idx}
                                    className={`bg-gradient-to-r ${getTypeStyle(insight.type)} backdrop-blur-xl rounded-2xl p-6 border slide-up-bounce`}
                                    style={{ animationDelay: `${idx * 150}ms` }}
                                >
                                    <h3 className="text-2xl font-bold text-white mb-2">{insight.title}</h3>
                                    <p className="text-xl text-white/80">{insight.content}</p>
                                </div>
                            )) : (
                                <div className="text-center text-white/60 py-12">
                                    <p className="text-2xl">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ë©´ AI ì¸ì‚¬ì´íŠ¸ê°€ ìƒì„±ë©ë‹ˆë‹¤.</p>
                                </div>
                            )}
                        </div>
                    </div>
                </SlideWrapper>
            );
        };

        // Slide 13: Action Items Slide
        const ActionItemsSlide = ({ schoolData }) => {
            const { actionItems } = schoolData;
            
            return (
                <SlideWrapper>
                    <div className="w-full max-w-6xl fade-in-up">
                        <h2 className="text-5xl font-bold text-white mb-8">ğŸ¯ í•µì‹¬ ì‹¤í–‰ ê³¼ì œ</h2>
                        <div className="space-y-5">
                            {actionItems.length > 0 ? actionItems.map((item, index) => (
                                <div 
                                    key={index}
                                    className={`bg-white/95 backdrop-blur-xl rounded-3xl p-6 shadow-2xl flip-in`}
                                    style={{ animationDelay: `${index * 200}ms` }}
                                >
                                    <div className="flex items-start gap-6">
                                        <div className="w-20 h-20 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-4xl shadow-lg bounce">
                                            {item.icon}
                                        </div>
                                        <div className="flex-1 text-left">
                                            <div className="flex items-center gap-4 mb-4">
                                                <span className="px-5 py-2 bg-indigo-600 text-white rounded-full text-lg font-bold shadow-md">
                                                    ìš°ì„ ìˆœìœ„ {item.priority}
                                                </span>
                                                <h3 className="text-3xl font-bold text-gray-900">{item.title}</h3>
                                            </div>
                                            <ul className="flex flex-wrap gap-3">
                                                {item.details.map((detail, i) => (
                                                    <li key={i} className="flex items-center gap-2 bg-indigo-50 border-2 border-indigo-100 px-5 py-2 rounded-full text-lg font-semibold text-indigo-900">
                                                        <span className="text-indigo-600 font-bold">âœ“</span>
                                                        <span>{detail}</span>
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            )) : (
                                <div className="text-center text-white/60 py-12">
                                    <p className="text-2xl">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ë©´ ì‹¤í–‰ ê³¼ì œê°€ ìƒì„±ë©ë‹ˆë‹¤.</p>
                                </div>
                            )}
                        </div>
                    </div>
                </SlideWrapper>
            );
        };

        // Slide 14: Roadmap Slide
        const RoadmapSlide = ({ schoolData }) => (
            <SlideWrapper>
                <div className="w-full max-w-6xl fade-in-up">
                    <h2 className="text-5xl font-bold text-white mb-16">ğŸ—ºï¸ {parseInt(schoolData.academicYear) + 1} ì‹¤í–‰ ë¡œë“œë§µ</h2>
                    <div className="relative">
                        <div className="absolute top-1/2 left-0 right-0 h-2 bg-white/20 rounded-full"></div>
                        <div className="grid grid-cols-4 gap-8 relative">
                            {schoolData.roadmap.map((item, index) => (
                                <div 
                                    key={index} 
                                    className={`text-center slide-up-bounce`}
                                    style={{ animationDelay: `${index * 200}ms` }}
                                >
                                    <div className="mb-8">
                                        <div 
                                            className={`w-20 h-20 mx-auto rounded-full border-4 border-white shadow-2xl glow wave-${index + 1}`}
                                            style={{ backgroundColor: item.color }}
                                        ></div>
                                    </div>
                                    <div className="bg-white/95 backdrop-blur-xl rounded-3xl p-6 shadow-xl card-3d">
                                        <div className="text-3xl font-black text-gray-900 mb-2">{item.quarter}</div>
                                        <div className="text-lg text-gray-500 mb-4">{item.period}</div>
                                        <div className="text-lg font-semibold text-gray-700">{item.task}</div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            </SlideWrapper>
        );

        // Slide 15: Goal Slide
        const GoalSlide = ({ schoolData }) => {
            const { goal } = schoolData;
            const currentScore = useCountUp(goal.currentScore, 0, 2000, 2);
            const targetScore = useCountUp(goal.targetScore, 0, 2500, 2);
            
            return (
                <SlideWrapper>
                    <div className="w-full max-w-5xl zoom-in">
                        <h2 className="text-6xl font-bold text-white mb-16">ğŸ¯ {parseInt(schoolData.academicYear) + 1} ëª©í‘œ</h2>
                        <div className="bg-white/10 backdrop-blur-xl rounded-3xl p-16 border border-white/20">
                            <p className="text-4xl text-white/70 font-semibold mb-12 text-center">ì¢…í•© ë§Œì¡±ë„</p>
                            <div className="flex items-center justify-center gap-16">
                                <div className="text-center">
                                    <p className="text-2xl text-white/60 mb-4">í˜„ì¬</p>
                                    <span className="text-8xl font-black text-white number-counter">{currentScore.toFixed(2)}</span>
                                </div>
                                <span className="text-8xl text-white/50 bounce">â†’</span>
                                <div className="text-center">
                                    <p className="text-2xl text-green-300 mb-4">ëª©í‘œ</p>
                                    <span className="text-8xl font-black text-green-400 number-counter glow">{targetScore.toFixed(2)}</span>
                                </div>
                            </div>
                            <div className="mt-12 text-center">
                                <span className="inline-block px-8 py-4 bg-green-500/20 rounded-full text-3xl font-bold text-green-300 border border-green-400/30">
                                    ğŸ“ˆ +{(goal.targetScore - goal.currentScore).toFixed(2)}ì  ìƒìŠ¹ ëª©í‘œ
                                </span>
                            </div>
                        </div>
                    </div>
                </SlideWrapper>
            );
        };

        // Slide 16: Closing Slide
        const ClosingSlide = ({ schoolData }) => (
            <SlideWrapper>
                <div className="zoom-in">
                    <div className="inline-block p-12 bg-white/10 backdrop-blur-xl rounded-3xl border border-white/20 mb-12 float glow">
                        <div className="w-48 h-48 text-white">
                            <SchoolIcon />
                        </div>
                    </div>
                    <h2 className="display-2 text-white mb-8">ê°ì‚¬í•©ë‹ˆë‹¤</h2>
                    <p className="text-4xl text-white/80 font-medium mb-4">
                        ë” ë‚˜ì€ <span className="text-yellow-300 font-bold">{schoolData.schoolName}</span>ì„ ìœ„í•´
                    </p>
                    <p className="text-4xl text-white/80 font-medium mb-12">
                        í•¨ê»˜ ë‚˜ì•„ê°‘ì‹œë‹¤
                    </p>
                    <div className="flex items-center justify-center gap-6 text-6xl fade-in-up stagger-3">
                        <span className="wave-1">ğŸ“</span>
                        <span className="wave-2">ğŸ“š</span>
                        <span className="wave-3">ğŸ’ª</span>
                        <span className="wave-4">ğŸŒŸ</span>
                    </div>
                </div>
            </SlideWrapper>
        );

        // Presentation Mode Component
        const PremiumPresentationMode = ({ schoolData, onExit, startSlide = 0 }) => {
            const [currentSlide, setCurrentSlide] = useState(startSlide);
            
            const slides = [
                <TitleSlide key={0} schoolData={schoolData} />,
                <OverallScoreSlide key={1} schoolData={schoolData} />,
                <ParticipantsSlide key={2} schoolData={schoolData} />,
                <ResponseRateSlide key={3} schoolData={schoolData} />,
                <CategoryChangeSlide key={4} schoolData={schoolData} />,
                <ComparisonSlide key={5} schoolData={schoolData} />,
                <TopItemsTeacherSlide key={6} schoolData={schoolData} />,
                <TopItemsStudentSlide key={7} schoolData={schoolData} />,
                <ImprovementTeacherSlide key={8} schoolData={schoolData} />,
                <ImprovementStudentSlide key={9} schoolData={schoolData} />,
                <TrendSlide key={10} schoolData={schoolData} />,
                <TrendBarChartSlide key={11} schoolData={schoolData} />,
                <InsightsSlide key={12} schoolData={schoolData} />,
                <ActionItemsSlide key={13} schoolData={schoolData} />,
                <RoadmapSlide key={14} schoolData={schoolData} />,
                <GoalSlide key={15} schoolData={schoolData} />,
                <ClosingSlide key={16} schoolData={schoolData} />,
            ];
            
            const totalSlides = slides.length;
            
            const goNext = () => {
                setCurrentSlide(prev => Math.min(prev + 1, totalSlides - 1));
            };
            
            const goPrev = () => {
                setCurrentSlide(prev => Math.max(prev - 1, 0));
            };
            
            useEffect(() => {
                const handleKey = (e) => {
                    if (e.key === 'ArrowRight' || e.key === ' ' || e.key === 'Enter') {
                        e.preventDefault();
                        goNext();
                    } else if (e.key === 'ArrowLeft') {
                        e.preventDefault();
                        goPrev();
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        onExit();
                    }
                };
                
                window.addEventListener('keydown', handleKey);
                return () => window.removeEventListener('keydown', handleKey);
            }, [currentSlide]);
            
            return (
                <div className="fixed inset-0 presentation-slide z-50">
                    <div className="relative z-10 h-full flex flex-col">
                        <div className="flex-1">
                            {slides[currentSlide]}
                        </div>
                        <div className="p-6">
                            <div className="max-w-3xl mx-auto">
                                <div className="flex items-center justify-between mb-4">
                                    <span className="text-white/60 text-lg font-medium">
                                        {currentSlide + 1} / {totalSlides}
                                    </span>
                                    <div className="flex items-center gap-4">
                                        <button 
                                            onClick={goPrev}
                                            disabled={currentSlide === 0}
                                            className="px-6 py-3 bg-white/20 hover:bg-white/30 disabled:opacity-30 text-white rounded-xl transition-all text-lg font-semibold"
                                        >
                                            â† ì´ì „
                                        </button>
                                        <button 
                                            onClick={goNext}
                                            disabled={currentSlide === totalSlides - 1}
                                            className="px-6 py-3 bg-white/20 hover:bg-white/30 disabled:opacity-30 text-white rounded-xl transition-all text-lg font-semibold"
                                        >
                                            ë‹¤ìŒ â†’
                                        </button>
                                        <button 
                                            onClick={onExit}
                                            className="px-6 py-3 bg-red-500/80 hover:bg-red-600 text-white rounded-xl transition-all text-lg font-semibold"
                                        >
                                            ESC ì¢…ë£Œ
                                        </button>
                                    </div>
                                </div>
                                <div className="h-3 bg-white/20 rounded-full overflow-hidden">
                                    <div 
                                        className="h-full bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 rounded-full transition-all duration-500"
                                        style={{ width: `${((currentSlide + 1) / totalSlides) * 100}%` }}
                                    ></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // File Upload Component
        const FileUploadZone = ({ label, file, onFileSelect, accept = ".xlsx,.xls" }) => {
            const inputRef = useRef(null);
            
            const handleDrop = (e) => {
                e.preventDefault();
                const droppedFile = e.dataTransfer.files[0];
                if (droppedFile) onFileSelect(droppedFile);
            };
            
            return (
                <div 
                    className={`file-upload-zone ${file ? 'has-file' : ''}`}
                    onClick={() => inputRef.current?.click()}
                    onDrop={handleDrop}
                    onDragOver={(e) => e.preventDefault()}
                >
                    <input 
                        ref={inputRef}
                        type="file" 
                        accept={accept}
                        className="hidden"
                        onChange={(e) => {
                            if (e.target.files[0]) onFileSelect(e.target.files[0]);
                        }}
                    />
                    <div className="text-center">
                        {file ? (
                            <>
                                <span className="text-3xl">âœ…</span>
                                <p className="mt-2 text-sm font-semibold text-green-700">{file.name}</p>
                            </>
                        ) : (
                            <>
                                <span className="text-3xl">ğŸ“</span>
                                <p className="mt-2 text-sm font-medium text-gray-600">{label}</p>
                                <p className="text-xs text-gray-400">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</p>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        // Data Editor Modal (Enhanced)
        const DataEditorModal = ({ initialData, onSave, onClose }) => {
            const [data, setData] = useState(JSON.parse(JSON.stringify(initialData)));
            const [activeTab, setActiveTab] = useState('basic');
            const [files, setFiles] = useState({
                teacher: null,
                student: null,
                parent: null,
                staff: null,
                trend: null
            });
            const [isProcessing, setIsProcessing] = useState(false);
            const [processStatus, setProcessStatus] = useState('');
            
            const updateField = (path, value) => {
                setData(prev => {
                    const newData = JSON.parse(JSON.stringify(prev));
                    const keys = path.split('.');
                    let current = newData;
                    for (let i = 0; i < keys.length - 1; i++) {
                        current = current[keys[i]];
                    }
                    current[keys[keys.length - 1]] = value;
                    return newData;
                });
            };
            
            const handleFileSelect = (type, file) => {
                setFiles(prev => ({ ...prev, [type]: file }));
            };
            
            const processFiles = async () => {
                setIsProcessing(true);
                setProcessStatus('íŒŒì¼ ë¶„ì„ ì¤‘...');
                
                try {
                    const newData = JSON.parse(JSON.stringify(data));
                    let teacherData = { respondentCount: 0, averageScore: 0, highestScore: 0, lowestScore: 0, topItems: [], bottomItems: [] };
                    let studentData = { respondentCount: 0, averageScore: 0, highestScore: 0, lowestScore: 0, topItems: [], bottomItems: [] };
                    let parentData = { respondentCount: 0, averageScore: 0, highestScore: 0, lowestScore: 0, topItems: [], bottomItems: [] };
                    let staffData = { respondentCount: 0, averageScore: 0, highestScore: 0, lowestScore: 0, topItems: [], bottomItems: [] };
                    
                    // Process Teacher file
                    if (files.teacher) {
                        setProcessStatus('êµì› ë°ì´í„° ë¶„ì„ ì¤‘...');
                        const rawData = await parseExcelFile(files.teacher);
                        teacherData = parseRespondentFile(rawData, 'teacher');
                        newData.respondentData[0].value = teacherData.respondentCount;
                        newData.respondentData[0].avg = teacherData.averageScore;
                        newData.comparisonData.teacher = {
                            average: teacherData.averageScore,
                            highest: teacherData.highestScore,
                            lowest: teacherData.lowestScore
                        };
                        newData.topBottomItems.teacherTop = teacherData.topItems;
                        newData.topBottomItems.teacherBottom = teacherData.bottomItems;
                    }
                    
                    // Process Student file
                    if (files.student) {
                        setProcessStatus('í•™ìƒ ë°ì´í„° ë¶„ì„ ì¤‘...');
                        const rawData = await parseExcelFile(files.student);
                        studentData = parseRespondentFile(rawData, 'student');
                        newData.respondentData[1].value = studentData.respondentCount;
                        newData.respondentData[1].avg = studentData.averageScore;
                        newData.comparisonData.student = {
                            average: studentData.averageScore,
                            highest: studentData.highestScore,
                            lowest: studentData.lowestScore
                        };
                        newData.topBottomItems.studentTop = studentData.topItems;
                        newData.topBottomItems.studentBottom = studentData.bottomItems;
                    }
                    
                    // Process Parent file
                    if (files.parent) {
                        setProcessStatus('í•™ë¶€ëª¨ ë°ì´í„° ë¶„ì„ ì¤‘...');
                        const rawData = await parseExcelFile(files.parent);
                        parentData = parseRespondentFile(rawData, 'parent');
                        newData.respondentData[2].value = parentData.respondentCount;
                        newData.respondentData[2].avg = parentData.averageScore;
                        newData.comparisonData.parent = {
                            average: parentData.averageScore,
                            highest: parentData.highestScore,
                            lowest: parentData.lowestScore
                        };
                    }
                    
                    // Process Staff file
                    if (files.staff) {
                        setProcessStatus('ì§ì› ë°ì´í„° ë¶„ì„ ì¤‘...');
                        const rawData = await parseExcelFile(files.staff);
                        staffData = parseRespondentFile(rawData, 'staff');
                        newData.respondentData[3].value = staffData.respondentCount;
                        newData.respondentData[3].avg = staffData.averageScore;
                        newData.comparisonData.staff = {
                            average: staffData.averageScore,
                            highest: staffData.highestScore,
                            lowest: staffData.lowestScore
                        };
                    }
                    
                    // Process Trend file
                    if (files.trend) {
                        setProcessStatus('ì—°ë„ë³„ ì¶”ì´ ë°ì´í„° ë¶„ì„ ì¤‘...');
                        const rawData = await parseExcelFile(files.trend);
                        const trendResult = parseTrendFile(rawData);
                        if (trendResult.length > 0) {
                            newData.trendData = trendResult;
                        }
                    }
                    
                    // Calculate totals
                    const totalParticipants = newData.respondentData.reduce((sum, r) => sum + r.value, 0);
                    
                    // Calculate simple overall average (ë‹¨ìˆœ í‰ê· )
                    let overallAvg = 0;
                    const validAvgs = newData.respondentData.filter(r => r.avg > 0).map(r => r.avg);
                    
                    if (validAvgs.length > 0) {
                        overallAvg = parseFloat((validAvgs.reduce((a, b) => a + b, 0) / validAvgs.length).toFixed(2));
                    }
                    
                    // Update KPI data
                    newData.kpiData[0].value = overallAvg;
                    newData.kpiData[1].value = totalParticipants;
                    
                    // Calculate change from previous year using trend data
                    if (newData.trendData.length >= 2) {
                        const lastYear = newData.trendData[newData.trendData.length - 1];
                        const prevYear = newData.trendData[newData.trendData.length - 2];
                        
                        // í˜„ì¬ ì—°ë„ ë°ì´í„°ë¡œ trend ì—…ë°ì´íŠ¸
                        const currentYearStr = newData.academicYear;
                        const lastTrendIdx = newData.trendData.findIndex(t => t.year === currentYearStr);
                        if (lastTrendIdx >= 0) {
                            // í˜„ì¬ íŒŒì‹±í•œ ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸
                            if (teacherData.averageScore > 0) newData.trendData[lastTrendIdx].teacher = teacherData.averageScore;
                            if (studentData.averageScore > 0) newData.trendData[lastTrendIdx].student = studentData.averageScore;
                            if (parentData.averageScore > 0) newData.trendData[lastTrendIdx].parent = parentData.averageScore;
                            if (staffData.averageScore > 0) newData.trendData[lastTrendIdx].staff = staffData.averageScore;
                            newData.trendData[lastTrendIdx].overall = overallAvg;
                        }
                        
                        // ì „ë…„ ëŒ€ë¹„ ë³€í™” ê³„ì‚°
                        const prevYearData = newData.trendData[newData.trendData.length - 2];
                        const change = parseFloat((overallAvg - prevYearData.overall).toFixed(2));
                        
                        newData.kpiData[0].change = change;
                        newData.kpiData[0].changeType = change >= 0 ? 'increase' : 'decrease';
                        newData.kpiData[2].value = change;
                        newData.kpiData[2].change = change;
                        newData.kpiData[2].changeType = change >= 0 ? 'increase' : 'decrease';
                        
                        // ì°¸ì—¬ ì¸ì› ë³€í™”ë„ ê³„ì‚° (ì„ì˜ë¡œ ì „ë…„ ëŒ€ë¹„ ì¦ê°€ë¡œ ì„¤ì •)
                        newData.kpiData[1].change = 0; // ì „ë…„ë„ ë°ì´í„° ì—†ìœ¼ë©´ 0
                    }
                    
                    // Update goal current score
                    newData.goal.currentScore = overallAvg;
                    
                    // Generate AI Insights
                    newData.aiInsights = generateAIInsights(teacherData, studentData, parentData, staffData);
                    
                    // Generate Action Items
                    newData.actionItems = generateActionItems(teacherData, studentData);
                    
                    // Generate Voices from lowest items
                    newData.voices = [];
                    if (teacherData.topItems.length > 0) {
                        newData.voices.push({
                            emoji: 'ğŸ˜Š',
                            text: teacherData.topItems[0].title,
                            source: 'êµì›'
                        });
                    }
                    if (studentData.bottomItems.length > 0) {
                        newData.voices.push({
                            emoji: 'ğŸ˜Ÿ',
                            text: studentData.bottomItems[0].title + ' ê°œì„  í•„ìš”',
                            source: 'í•™ìƒ'
                        });
                    }
                    if (parentData.topItems && parentData.topItems.length > 0) {
                        newData.voices.push({
                            emoji: 'ğŸ’¡',
                            text: parentData.topItems[0].title,
                            source: 'í•™ë¶€ëª¨'
                        });
                    }
                    
                    // Update categoryData from parsed sub-category scores (í•™ìƒ ë°ì´í„° ê¸°ì¤€)
                    const categoryNames = ['í•™êµìì¹˜', 'êµìœ¡ê³¼ì • í¸ì„±Â·ìš´ì˜', 'ìˆ˜ì—…Â·í‰ê°€ í˜ì‹ ', 'ì±…ì„êµìœ¡', 'ì¸ë¬¸Â·ê³¼í•™Â·ì˜ˆì²´ëŠ¥', 'ë¯¼ì£¼ì‹œë¯¼ êµìœ¡', 'ì•ˆì „í•œ êµìœ¡ê³µê°„'];
                    const currentYear = newData.academicYear;
                    const prevYear = String(parseInt(currentYear) - 1);
                    
                    // ì„¸ë¶€ì˜ì—­ â†’ ì¹´í…Œê³ ë¦¬ ë§¤í•‘
                    const mapSubCategoryToCategory = (subCatName) => {
                        if (!subCatName) return null;
                        const name = subCatName.toUpperCase();
                        
                        if (name.includes('â…¢-1') || name.includes('III-1') || (name.includes('ì±…ì„êµìœ¡'.toUpperCase()) && !name.includes('II'))) return 'ì±…ì„êµìœ¡';
                        if (name.includes('â…¢-2') || name.includes('III-2') || name.includes('ì¸ë¬¸'.toUpperCase()) || name.includes('ì˜ˆì²´ëŠ¥'.toUpperCase())) return 'ì¸ë¬¸Â·ê³¼í•™Â·ì˜ˆì²´ëŠ¥';
                        if (name.includes('â…¢-3') || name.includes('III-3') || (name.includes('ë¯¼ì£¼ì‹œë¯¼'.toUpperCase()) && !name.includes('II'))) return 'ë¯¼ì£¼ì‹œë¯¼ êµìœ¡';
                        if (name.includes('â…¢-4') || name.includes('III-4') || (name.includes('ì•ˆì „'.toUpperCase()) && name.includes('êµìœ¡ê³µê°„'.toUpperCase()))) return 'ì•ˆì „í•œ êµìœ¡ê³µê°„';
                        
                        if (name.includes('II-1') || (name.includes('êµìœ¡ê³¼ì •'.toUpperCase()) && name.includes('í¸ì„±'.toUpperCase()))) return 'êµìœ¡ê³¼ì • í¸ì„±Â·ìš´ì˜';
                        if (name.includes('II-2') || (name.includes('ìˆ˜ì—…'.toUpperCase()) && name.includes('í‰ê°€'.toUpperCase()) && name.includes('í˜ì‹ '.toUpperCase()))) return 'ìˆ˜ì—…Â·í‰ê°€ í˜ì‹ ';
                        
                        if (name.includes('I-1.') || name.includes('í•™êµììœ¨'.toUpperCase())) return 'í•™êµìì¹˜-1';
                        if (name.includes('I-2.') || (name.includes('í•™ë¶€ëª¨'.toUpperCase()) && name.includes('ì§€ì—­ì‚¬íšŒ'.toUpperCase()))) return 'í•™êµìì¹˜-2';
                        
                        return null;
                    };
                    
                    const categoryScoresCurrent = {};
                    const categoryScoresPrev = {};
                    
                    const subScores = studentData.subCategoryScores || {};
                    const subScoresPrev = studentData.subCategoryScoresPrev || {};
                    
                    for (const [subCat, score] of Object.entries(subScores)) {
                        const category = mapSubCategoryToCategory(subCat);
                        if (category) {
                            if (!categoryScoresCurrent[category]) {
                                categoryScoresCurrent[category] = [];
                            }
                            categoryScoresCurrent[category].push(score);
                        }
                    }
                    
                    for (const [subCat, score] of Object.entries(subScoresPrev)) {
                        const category = mapSubCategoryToCategory(subCat);
                        if (category) {
                            if (!categoryScoresPrev[category]) {
                                categoryScoresPrev[category] = [];
                            }
                            categoryScoresPrev[category].push(score);
                        }
                    }
                    
                    const calcCategoryAvg = (catName, scoresObj) => {
                        if (catName === 'í•™êµìì¹˜') {
                            const scores = [];
                            if (scoresObj['í•™êµìì¹˜-1']) scores.push(...scoresObj['í•™êµìì¹˜-1']);
                            if (scoresObj['í•™êµìì¹˜-2']) scores.push(...scoresObj['í•™êµìì¹˜-2']);
                            return scores.length > 0 ? parseFloat((scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(2)) : 0;
                        }
                        const scores = scoresObj[catName] || [];
                        return scores.length > 0 ? parseFloat((scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(2)) : 0;
                    };
                    
                    newData.categoryData = categoryNames.map(name => {
                        const currentScore = calcCategoryAvg(name, categoryScoresCurrent);
                        const prevScore = calcCategoryAvg(name, categoryScoresPrev);
                        
                        return {
                            name,
                            [prevYear]: prevScore,
                            [currentYear]: currentScore,
                            '2024': prevScore,
                            '2025': currentScore
                        };
                    });
                    
                    setProcessStatus('ë°ì´í„° ì €ì¥ ì¤‘...');
                    setData(newData);
                    setProcessStatus('âœ… ì™„ë£Œ! ' + totalParticipants + 'ëª…ì˜ ë°ì´í„°ê°€ ë¶„ì„ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    
                    setTimeout(() => {
                        setIsProcessing(false);
                    }, 2000);
                    
                } catch (error) {
                    console.error('Error processing files:', error);
                    setProcessStatus('âŒ ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
                    setTimeout(() => {
                        setIsProcessing(false);
                        setProcessStatus('');
                    }, 3000);
                }
            };
            
            const handleSave = () => {
                saveToStorage(data);
                onSave(data);
                onClose();
            };
            
            const handleReset = () => {
                if (confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    localStorage.removeItem(STORAGE_KEY);
                    setData(getDefaultData());
                    setFiles({
                        teacher: null,
                        student: null,
                        parent: null,
                        staff: null,
                        trend: null
                    });
                }
            };

            return (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-3xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                        <div className="p-6 border-b border-gray-200 flex justify-between items-center">
                            <h2 className="text-2xl font-bold text-gray-900">ğŸ“ ë°ì´í„° ì„¤ì •</h2>
                            <button 
                                onClick={onClose}
                                className="p-2 hover:bg-gray-100 rounded-xl transition-all text-2xl"
                            >
                                âœ•
                            </button>
                        </div>
                        
                        {/* Tabs */}
                        <div className="flex border-b border-gray-200 px-6">
                            <button 
                                className={`px-6 py-3 font-semibold transition-all ${activeTab === 'basic' ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-gray-500'}`}
                                onClick={() => setActiveTab('basic')}
                            >
                                ê¸°ë³¸ ì •ë³´
                            </button>
                            <button 
                                className={`px-6 py-3 font-semibold transition-all ${activeTab === 'upload' ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-gray-500'}`}
                                onClick={() => setActiveTab('upload')}
                            >
                                ë°ì´í„° ì—…ë¡œë“œ
                            </button>
                            <button 
                                className={`px-6 py-3 font-semibold transition-all ${activeTab === 'settings' ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-gray-500'}`}
                                onClick={() => setActiveTab('settings')}
                            >
                                ëª©í‘œ ì„¤ì •
                            </button>
                        </div>

                        <div className="flex-1 overflow-y-auto p-6">
                            {activeTab === 'basic' && (
                                <div className="space-y-6 max-w-2xl mx-auto">
                                    <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-2xl">
                                        <h3 className="text-xl font-bold text-gray-900 mb-4">ğŸ“š í•™êµ ì •ë³´</h3>
                                        <div className="space-y-4">
                                            <div>
                                                <label className="form-label">í•™êµ ì´ë¦„</label>
                                                <input
                                                    type="text"
                                                    value={data.schoolName}
                                                    onChange={(e) => updateField('schoolName', e.target.value)}
                                                    className="form-input"
                                                    placeholder="ì˜ˆ: ì›ë¬µê³ ë“±í•™êµ"
                                                />
                                            </div>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="form-label">í•™ë…„ë„</label>
                                                    <input
                                                        type="text"
                                                        value={data.academicYear}
                                                        onChange={(e) => updateField('academicYear', e.target.value)}
                                                        className="form-input"
                                                        placeholder="ì˜ˆ: 2025"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="form-label">í•™ê¸°</label>
                                                    <select
                                                        value={data.semester}
                                                        onChange={(e) => updateField('semester', e.target.value)}
                                                        className="form-input"
                                                    >
                                                        <option value="1í•™ê¸°">1í•™ê¸°</option>
                                                        <option value="2í•™ê¸°">2í•™ê¸°</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-gradient-to-r from-green-50 to-emerald-50 p-6 rounded-2xl">
                                        <h3 className="text-xl font-bold text-gray-900 mb-4">ğŸ“Š ê·¸ë£¹ë³„ ì‹¤ì œ ì‘ë‹µë¥  ì„¤ì •</h3>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="form-label">êµì‚¬ ì‘ë‹µë¥  (%)</label>
                                                <input
                                                    type="number"
                                                    value={data.responseRates.teacher}
                                                    onChange={(e) => updateField('responseRates.teacher', parseFloat(e.target.value))}
                                                    className="form-input"
                                                    min="0"
                                                    max="100"
                                                />
                                            </div>
                                            <div>
                                                <label className="form-label">í•™ìƒ ì‘ë‹µë¥  (%)</label>
                                                <input
                                                    type="number"
                                                    value={data.responseRates.student}
                                                    onChange={(e) => updateField('responseRates.student', parseFloat(e.target.value))}
                                                    className="form-input"
                                                    min="0"
                                                    max="100"
                                                />
                                            </div>
                                            <div>
                                                <label className="form-label">í•™ë¶€ëª¨ ì‘ë‹µë¥  (%)</label>
                                                <input
                                                    type="number"
                                                    value={data.responseRates.parent}
                                                    onChange={(e) => updateField('responseRates.parent', parseFloat(e.target.value))}
                                                    className="form-input"
                                                    min="0"
                                                    max="100"
                                                />
                                            </div>
                                            <div>
                                                <label className="form-label">ì§ì› ì‘ë‹µë¥  (%)</label>
                                                <input
                                                    type="number"
                                                    value={data.responseRates.staff}
                                                    onChange={(e) => updateField('responseRates.staff', parseFloat(e.target.value))}
                                                    className="form-input"
                                                    min="0"
                                                    max="100"
                                                />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {activeTab === 'upload' && (
                                <div className="space-y-6 max-w-2xl mx-auto">
                                    <div className="bg-gradient-to-r from-purple-50 to-pink-50 p-6 rounded-2xl">
                                        <h3 className="text-xl font-bold text-gray-900 mb-2">ğŸ“ ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</h3>
                                        <p className="text-sm text-gray-600 mb-4">í•™êµí‰ê°€ ê²°ê³¼ ë¶„ì„ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”. íŒŒì¼ëª…ì— ê´€ê³„ì—†ì´ ê° í•­ëª©ì— ë§ëŠ” íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                                        
                                        <div className="grid grid-cols-2 gap-4 mb-6">
                                            <FileUploadZone 
                                                label="êµì› ê²°ê³¼ íŒŒì¼"
                                                file={files.teacher}
                                                onFileSelect={(f) => handleFileSelect('teacher', f)}
                                            />
                                            <FileUploadZone 
                                                label="í•™ìƒ ê²°ê³¼ íŒŒì¼"
                                                file={files.student}
                                                onFileSelect={(f) => handleFileSelect('student', f)}
                                            />
                                            <FileUploadZone 
                                                label="í•™ë¶€ëª¨ ê²°ê³¼ íŒŒì¼"
                                                file={files.parent}
                                                onFileSelect={(f) => handleFileSelect('parent', f)}
                                            />
                                            <FileUploadZone 
                                                label="ì§ì› ê²°ê³¼ íŒŒì¼"
                                                file={files.staff}
                                                onFileSelect={(f) => handleFileSelect('staff', f)}
                                            />
                                        </div>
                                        
                                        <div className="mb-6">
                                            <FileUploadZone 
                                                label="ì—°ë„ë³„ ê²°ê³¼ ì¶”ì´ íŒŒì¼"
                                                file={files.trend}
                                                onFileSelect={(f) => handleFileSelect('trend', f)}
                                            />
                                        </div>
                                        
                                        <button 
                                            onClick={processFiles}
                                            disabled={isProcessing || Object.values(files).every(f => f === null)}
                                            className="w-full py-4 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 disabled:opacity-50 text-white font-bold text-lg transition-all"
                                        >
                                            {isProcessing ? processStatus : 'ğŸ”„ íŒŒì¼ ë¶„ì„ ë° ë°ì´í„° ìƒì„±'}
                                        </button>
                                    </div>
                                    
                                    <div className="bg-yellow-50 border border-yellow-200 p-4 rounded-xl">
                                        <p className="text-sm text-yellow-800">
                                            ğŸ’¡ <strong>íŒ:</strong> ì—…ë¡œë“œëœ ë°ì´í„°ëŠ” ë¸Œë¼ìš°ì €ì— ì €ì¥ë©ë‹ˆë‹¤. ë‹¤ìŒì— ì´ ì•±ì„ ì—´ë©´ ì €ì¥ëœ ë°ì´í„°ê°€ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì™€ì§‘ë‹ˆë‹¤.
                                        </p>
                                    </div>
                                </div>
                            )}
                            
                            {activeTab === 'settings' && (
                                <div className="space-y-6 max-w-2xl mx-auto">
                                    <div className="bg-gradient-to-r from-amber-50 to-orange-50 p-6 rounded-2xl">
                                        <h3 className="text-xl font-bold text-gray-900 mb-4">ğŸ¯ ë§Œì¡±ë„ ëª©í‘œ</h3>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="form-label">í˜„ì¬ ì ìˆ˜</label>
                                                <input
                                                    type="number"
                                                    value={data.goal.currentScore}
                                                    onChange={(e) => updateField('goal.currentScore', parseFloat(e.target.value))}
                                                    className="form-input"
                                                    step="0.01"
                                                    min="0"
                                                    max="5"
                                                />
                                            </div>
                                            <div>
                                                <label className="form-label">ëª©í‘œ ì ìˆ˜</label>
                                                <input
                                                    type="number"
                                                    value={data.goal.targetScore}
                                                    onChange={(e) => updateField('goal.targetScore', parseFloat(e.target.value))}
                                                    className="form-input"
                                                    step="0.01"
                                                    min="0"
                                                    max="5"
                                                />
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-red-50 border border-red-200 p-4 rounded-xl">
                                        <h4 className="font-bold text-red-800 mb-2">âš ï¸ ë°ì´í„° ì´ˆê¸°í™”</h4>
                                        <p className="text-sm text-red-700 mb-4">ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ì´ˆê¸° ìƒíƒœë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.</p>
                                        <button 
                                            onClick={handleReset}
                                            className="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-xl font-semibold transition-all"
                                        >
                                            ğŸ—‘ï¸ ë°ì´í„° ì´ˆê¸°í™”
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="p-6 border-t border-gray-200 flex justify-end gap-3 bg-gray-50 rounded-b-3xl">
                            <button 
                                onClick={onClose}
                                className="px-8 py-3 rounded-xl bg-gray-200 hover:bg-gray-300 font-bold text-gray-700 transition-all"
                            >
                                ì·¨ì†Œ
                            </button>
                            <button 
                                onClick={handleSave}
                                className="px-8 py-3 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white font-bold shadow-lg transition-all"
                            >
                                ğŸ’¾ ì €ì¥í•˜ê¸°
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // App Component
        const App = () => {
            const [appState, setAppState] = useState('splash');
            const [isEditorOpen, setEditorOpen] = useState(false);
            const [schoolData, setSchoolData] = useState(() => {
                const saved = loadFromStorage();
                return saved || getDefaultData();
            });
            const [presentationStartSlide, setPresentationStartSlide] = useState(0);

            const handleFinishSplash = useCallback(() => setAppState('dashboard'), []);
            
            const handleEnterPresentation = useCallback((startSlide = 0) => {
                setPresentationStartSlide(startSlide);
                setAppState('presentation');
            }, []);
            
            const handleExitPresentation = useCallback(() => { 
                if (document.fullscreenElement) document.exitFullscreen();
                setAppState('dashboard'); 
            }, []);
            
            const handleSaveData = useCallback((newData) => {
                setSchoolData(newData);
                saveToStorage(newData);
            }, []);

            const renderContent = () => {
                switch (appState) {
                    case 'splash': 
                        return <PremiumSplashScreen onFinished={handleFinishSplash} schoolData={schoolData} />;
                    case 'dashboard': 
                        return <PremiumDashboard 
                            schoolData={schoolData} 
                            onEnterPresentation={handleEnterPresentation}
                            onOpenDataEditor={() => setEditorOpen(true)} 
                        />;
                    case 'presentation': 
                        return <PremiumPresentationMode 
                            schoolData={schoolData} 
                            onExit={handleExitPresentation}
                            startSlide={presentationStartSlide} 
                        />;
                    default: 
                        return null;
                }
            };

            return (
                <>
                    {renderContent()}
                    {isEditorOpen && ( 
                        <DataEditorModal 
                            initialData={schoolData} 
                            onSave={handleSaveData}
                            onClose={() => setEditorOpen(false)} 
                        /> 
                    )}
                </>
            );
        };

        const rootElement = document.getElementById('root');
        const root = createRoot(rootElement);
        root.render(<App />);
    </script>
</body>
</html>
